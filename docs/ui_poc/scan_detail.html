<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Gateway Suite - Scan Details</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
      --primary: #0066ff;
      --primary-dark: #0052cc;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius: 8px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--gray-50); color: var(--gray-900); line-height: 1.5; padding-top: 56px; }

    /* Navigation */
    .nav { background: var(--gray-900); padding: 0 24px; display: flex; align-items: center; height: 56px; position: sticky; top: 0; z-index: 100; }
    .nav-brand { color: #fff; font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .nav-brand svg { width: 28px; height: 28px; }
    .nav-links { display: flex; gap: 4px; margin-left: 40px; }
    .nav-link { color: var(--gray-300); text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; transition: all 0.15s; }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .nav-link.active { color: #fff; background: var(--primary); }
    .nav-status { margin-left: auto; display: flex; align-items: center; gap: 8px; color: var(--gray-300); font-size: 13px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Main Content */
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    /* Breadcrumb */
    .breadcrumb { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 14px; }
    .breadcrumb a { color: var(--primary); text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .breadcrumb span { color: var(--gray-600); }
    .breadcrumb svg { width: 16px; height: 16px; color: var(--gray-300); }

    /* Page Header */
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 24px; font-weight: 700; color: var(--gray-900); }
    .page-subtitle { color: var(--gray-600); font-size: 14px; margin-top: 4px; }

    /* Status Pill */
    .pill { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 999px; font-size: 13px; font-weight: 600; }
    .pill-passed { background: #d1fae5; color: #065f46; }
    .pill-failed { background: #fee2e2; color: #991b1b; }
    .pill-warn { background: #fef3c7; color: #92400e; }

    /* Meta Grid */
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .meta-card { background: #fff; border-radius: var(--radius); padding: 16px 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200); }
    .meta-label { font-size: 12px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .meta-value { font-size: 16px; font-weight: 600; color: var(--gray-900); }
    .meta-value.mono { font-family: 'SF Mono', Monaco, monospace; font-size: 13px; }

    /* Severity Summary */
    .severity-summary { background: #fff; border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200); margin-bottom: 24px; }
    .severity-summary h3 { font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 12px; }
    .severity-bars { display: flex; gap: 12px; flex-wrap: wrap; }
    .severity-item { display: flex; align-items: center; gap: 8px; }
    .severity-bar { height: 8px; border-radius: 4px; min-width: 40px; }
    .severity-bar.critical { background: var(--danger); }
    .severity-bar.high { background: #f97316; }
    .severity-bar.medium { background: var(--warning); }
    .severity-bar.low { background: #3b82f6; }
    .severity-count { font-size: 13px; font-weight: 600; color: var(--gray-700); }

    /* Table */
    .section-title { font-size: 18px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .section-title svg { width: 20px; height: 20px; color: var(--primary); }
    .table-container { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200); overflow: hidden; }
    table { border-collapse: collapse; width: 100%; }
    th { background: var(--gray-50); font-size: 12px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--gray-200); }
    td { padding: 14px 16px; font-size: 14px; border-bottom: 1px solid var(--gray-100); vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: var(--gray-50); }

    /* Severity Badge */
    .sev-badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .sev-critical { background: #fee2e2; color: #991b1b; }
    .sev-high { background: #ffedd5; color: #9a3412; }
    .sev-medium { background: #fef3c7; color: #92400e; }
    .sev-low { background: #dbeafe; color: #1e40af; }

    /* OWASP Tag */
    .owasp-tag { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: #ede9fe; color: #5b21b6; }

    /* Evidence Badge */
    .evidence-badge { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; background: var(--gray-100); color: var(--gray-600); }

    /* Summary Cell */
    .summary-text { color: var(--gray-700); line-height: 1.4; }
    .resource-text { font-family: 'SF Mono', Monaco, monospace; font-size: 12px; color: var(--gray-600); background: var(--gray-100); padding: 2px 6px; border-radius: 4px; }

    /* Empty State */
    .empty-state { text-align: center; padding: 48px 24px; color: var(--gray-600); }
  
    /* Responsive Design */
    @media (max-width: 1024px) {
      .nav-links { margin-left: 20px; gap: 2px; }
      .nav-link { padding: 6px 12px; font-size: 13px; }
      .container { padding: 16px; }
      .grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    }
    @media (max-width: 768px) {
      .nav { flex-wrap: wrap; height: auto; min-height: 56px; padding: 8px 16px; }
      .nav-brand { font-size: 16px; }
      .nav-brand svg { width: 24px; height: 24px; }
      .nav-links { width: 100%; margin-left: 0; margin-top: 8px; justify-content: center; }
      .nav-link { padding: 6px 10px; font-size: 12px; }
      .nav-status { width: 100%; justify-content: center; margin-top: 8px; margin-left: 0; }
      .container { padding: 12px; }
      .header { flex-direction: column; align-items: flex-start; }
      .grid { grid-template-columns: 1fr; }
      .side-stack { flex-direction: column; }
      body { padding-top: 0; }
    }
    @media (max-width: 480px) {
      .nav-link { padding: 4px 8px; font-size: 11px; }
      .card { padding: 12px; }
      .value { font-size: 16px; }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      MCP Gateway Suite
    </div>
    <div class="nav-links">
      <a href="settings_environments.html" class="nav-link">Environments</a>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="scans.html" class="nav-link active">Scans</a>
      <a href="allowlist.html" class="nav-link">AllowList</a>
      <a href="web_sandbox.html" class="nav-link">Web Sandbox</a>
      <a href="audit_log.html" class="nav-link">Audit Log</a>
      <a href="evidence_pack.html" class="nav-link">Evidence Pack</a>
    </div>
    <div class="nav-status">
      <span class="status-dot"></span>
      Demo Mode
    </div>
  </nav>

  <div class="container">
    <div class="breadcrumb">
      <a href="scans.html" data-i18n="scanDetail.breadcrumbScans">Scans</a>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      <span id="breadcrumbId">Scan Details</span>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px;">
      <button type="button" class="lang-btn" id="langJa" data-lang="ja">JA</button>
      <button type="button" class="lang-btn active" id="langEn" data-lang="en">EN</button>
    </div>

    <div id="summary"></div>

    <h2 class="section-title" id="findingsTitle">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      <span data-i18n="scanDetail.sectionFindings">Security Findings</span>
    </h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width:90px" data-i18n="scanDetail.thSeverity">Severity</th>
            <th style="width:100px" data-i18n="scanDetail.thCategory">Category</th>
            <th data-i18n="scanDetail.thSummary">Summary</th>
            <th style="width:140px" data-i18n="scanDetail.thResource">Resource</th>
            <th style="width:90px" data-i18n="scanDetail.thOwaspLlm">OWASP LLM</th>
            <th style="width:120px" data-i18n="scanDetail.thEvidence">Evidence</th>
          </tr>
        </thead>
        <tbody id="findingRows"></tbody>
      </table>
    </div>
  </div>

  <script src="mock_data.js"></script>
  <script src="api_client.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    // Default to first scan if no id param (demo mode friendly)
    var id = params.get("id");
    if (!id && window.suiteScanData && window.suiteScanData.scans && window.suiteScanData.scans.length) {
      id = window.suiteScanData.scans[0].id;
    }
    const summary = document.getElementById("summary");
    const rows = document.getElementById("findingRows");
    const breadcrumbId = document.getElementById("breadcrumbId");

    function formatTimestamp(ts) {
      if (!ts) return "-";
      const d = new Date(ts);
      return d.toLocaleString("ja-JP", { year: "numeric", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
    }

    function statusPill(status) {
      const cls = status === "passed" ? "pill-passed" : status === "warn" ? "pill-warn" : "pill-failed";
      return `<span class="pill ${cls}">${status}</span>`;
    }

    function t(key) { return window.tCommon ? window.tCommon(key) : key.split('.').pop(); }

    function renderMeta(scan) {
      if (!scan) {
        summary.innerHTML = `<div class="empty-state"><p>${t('scanDetail.notFound')} (id=${escapeHtml(id || "N/A")})</p></div>`;
        return;
      }
      breadcrumbId.textContent = scan.id;
      const sev = scan.severity_counts || {};
      summary.innerHTML = `
        <div class="page-header">
          <div>
            <h1 class="page-title">Scan: ${escapeHtml(scan.environment)} ${statusPill(scan.status)}</h1>
            <p class="page-subtitle">Scan ID: ${escapeHtml(scan.id)}</p>
            <div data-admin-session-banner-anchor="page-header"></div>
          </div>
        </div>

        <div class="meta-grid">
          <div class="meta-card"><div class="meta-label">${t('scanDetail.labelEnvironment')}</div><div class="meta-value">${escapeHtml(scan.environment)}</div></div>
          <div class="meta-card"><div class="meta-label">${t('scanDetail.labelProfile')}</div><div class="meta-value">${escapeHtml(scan.profile || "-")}</div></div>
          <div class="meta-card"><div class="meta-label">${t('scanDetail.labelStarted')}</div><div class="meta-value">${escapeHtml(formatTimestamp(scan.startedAt))}</div></div>
          <div class="meta-card"><div class="meta-label">${t('scanDetail.labelDuration')}</div><div class="meta-value">${scan.durationSeconds}s</div></div>
          <div class="meta-card"><div class="meta-label">${t('scanDetail.labelActor')}</div><div class="meta-value mono">${escapeHtml(scan.actor || "-")}</div></div>
        </div>

        <div class="severity-summary">
          <h3>${t('scanDetail.sectionSeverity')}</h3>
          <div class="severity-bars">
            <div class="severity-item"><div class="severity-bar critical" style="width:${Math.max(40, (sev.critical || 0) * 20)}px"></div><span class="severity-count">Critical: ${sev.critical || 0}</span></div>
            <div class="severity-item"><div class="severity-bar high" style="width:${Math.max(40, (sev.high || 0) * 20)}px"></div><span class="severity-count">High: ${sev.high || 0}</span></div>
            <div class="severity-item"><div class="severity-bar medium" style="width:${Math.max(40, (sev.medium || 0) * 20)}px"></div><span class="severity-count">Medium: ${sev.medium || 0}</span></div>
            <div class="severity-item"><div class="severity-bar low" style="width:${Math.max(40, (sev.low || 0) * 20)}px"></div><span class="severity-count">Low: ${sev.low || 0}</span></div>
          </div>
        </div>
      `;
    }

    function sevClass(sev) {
      const s = (sev || "").toLowerCase();
      if (s === "critical") return "sev-critical";
      if (s === "high") return "sev-high";
      if (s === "medium") return "sev-medium";
      return "sev-low";
    }

    function renderFindings(findings) {
      if (!findings || !findings.length) {
        rows.innerHTML = `<tr><td colspan="6" class="empty-state">No findings detected</td></tr>`;
        return;
      }
      rows.innerHTML = findings.map((f) => `<tr>
        <td><span class="sev-badge ${sevClass(f.severity)}">${escapeHtml(f.severity)}</span></td>
        <td>${escapeHtml(f.category)}</td>
        <td><div class="summary-text">${escapeHtml(f.summary)}</div></td>
        <td><code class="resource-text">${escapeHtml(f.resource)}</code></td>
        <td><span class="owasp-tag">${escapeHtml(f.owasp_llm_code)}</span><div style="font-size:10px;color:var(--gray-600);margin-top:2px">${escapeHtml(f.owasp_llm_title || "")}</div></td>
        <td><span class="evidence-badge">${escapeHtml(f.evidence_source)}</span></td>
      </tr>`).join("");
    }

    async function init() {
      const data = await window.apiClient.fetchScanDetail(id);
      renderMeta(data.scan);
      renderFindings(data.findings || []);
    }

    init();
  </script>
  <script>
    (function(){
      var langJa = document.getElementById('langJa');
      var langEn = document.getElementById('langEn');
      function updateLangButtons() {
        var lang = window.getLanguage ? window.getLanguage() : 'en';
        if (langJa) langJa.classList.toggle('active', lang === 'ja');
        if (langEn) langEn.classList.toggle('active', lang === 'en');
      }
      if (langJa) langJa.addEventListener('click', function() {
        if (window.setLanguage) window.setLanguage('ja');
        if (window.applyCommonI18n) window.applyCommonI18n();
        updateLangButtons();
        init();
      });
      if (langEn) langEn.addEventListener('click', function() {
        if (window.setLanguage) window.setLanguage('en');
        if (window.applyCommonI18n) window.applyCommonI18n();
        updateLangButtons();
        init();
      });
      if (window.applyCommonI18n) window.applyCommonI18n();
      updateLangButtons();
    })();
  </script>
</body>
</html>
