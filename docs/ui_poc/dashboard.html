<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Gateway Suite - Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;600;700&display=swap');
    html { background: #f9fafb; }
    body { opacity: 1; transition: opacity 0.08s ease-out; }
    body.loading { opacity: 0; }
    :root {
      --primary: #0066ff; --primary-dark: #0052cc;
      --success: #10b981; --warn: #f59e0b; --danger: #ef4444;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-600: #4b5563; --gray-700: #374151; --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --radius: 12px; --bg: var(--gray-50); --card: #fff;
      --border: var(--gray-200); --text: var(--gray-900); --muted: var(--gray-600);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', 'Noto Sans JP', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; padding-top: 56px; }
    a { color: var(--primary); text-decoration: none; }

    .nav { background: var(--gray-900); padding: 0 24px; display: flex; align-items: center; height: 56px; position: sticky; top: 0; z-index: 100; }
    .nav-brand { color: #fff; font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .nav-brand svg { width: 28px; height: 28px; }
    .nav-links { display: flex; gap: 4px; margin-left: 40px; flex-wrap: wrap; }
    .nav-link { color: var(--gray-300); text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; transition: all 0.15s; }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .nav-link.active { color: #fff; background: var(--primary); }
    .nav-status { margin-left: auto; display: flex; align-items: center; gap: 8px; color: var(--gray-300); font-size: 13px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
    .pipeline-step:hover { background: var(--gray-50); border-left-color: #8b5cf6 !important; }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .muted { color: var(--muted); font-size: 14px; }

    .lang-btn { padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; color: var(--gray-700); }
    .lang-btn:hover { background: var(--gray-50); }
    .lang-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* KPI Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 600px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .kpi-card.blue::before { background: var(--primary); }
    .kpi-card.green::before { background: var(--success); }
    .kpi-card.red::before { background: var(--danger); }
    .kpi-card.purple::before { background: #8b5cf6; }
    .kpi-card.amber::before { background: var(--warn); }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .kpi-value { font-size: 28px; font-weight: 800; line-height: 1.1; }
    .kpi-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .kpi-value.green { color: var(--success); }
    .kpi-value.red { color: var(--danger); }
    .kpi-value.blue { color: var(--primary); }

    /* Gateway Flow */
    .flow-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
    .flow-row { display: flex; align-items: center; justify-content: center; gap: 0; padding: 16px 0; flex-wrap: wrap; }
    .flow-box { border: 2px solid var(--border); border-radius: 12px; padding: 16px 24px; text-align: center; min-width: 160px; background: #fff; position: relative; }
    .flow-box.gateway { border-color: var(--primary); background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); min-width: 220px; }
    .flow-box.gateway .flow-box-title { color: var(--primary); }
    .flow-box-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
    .flow-box-sub { font-size: 12px; color: var(--muted); }
    .flow-box-metric { font-size: 20px; font-weight: 800; margin-top: 8px; }
    .flow-arrow { font-size: 24px; color: var(--gray-300); padding: 0 12px; flex-shrink: 0; }
    .flow-arrow.active { color: var(--primary); }
    .flow-tags { display: flex; gap: 6px; justify-content: center; margin-top: 8px; flex-wrap: wrap; }
    .flow-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
    .flow-tag.green { background: #d1fae5; color: #065f46; }
    .flow-tag.red { background: #fee2e2; color: #991b1b; }
    .flow-tag.amber { background: #fef3c7; color: #92400e; }

    /* Connected Agents Panel */
    .threat-landscape { background: linear-gradient(135deg, #fef2f2, #fff7ed); border: 1px solid #fca5a5; border-radius: var(--radius); padding: 16px 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
    .threat-landscape-header { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; font-size: 14px; font-weight: 600; color: #991b1b; }
    .threat-stats-row { display: flex; align-items: center; gap: 0; }
    .threat-stat { flex: 1; text-align: center; padding: 0 8px; }
    .threat-stat-value { font-size: 28px; font-weight: 800; color: var(--foreground); line-height: 1.2; font-variant-numeric: tabular-nums; }
    .threat-stat-value.danger { color: #dc2626; }
    .threat-stat-value.warning { color: #d97706; }
    .threat-stat-value.primary { color: var(--primary); font-size: 16px; font-weight: 700; }
    .threat-stat-label { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .threat-stat-divider { width: 1px; height: 40px; background: #e5e7eb; flex-shrink: 0; }
    .threat-cat-tag { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; background: #fff1f2; color: #be123c; border: 1px solid #fecdd3; }
    @media (max-width: 640px) { .threat-stats-row { flex-wrap: wrap; gap: 12px; } .threat-stat-divider { display: none; } .threat-stat { min-width: 45%; } }
    .threat-cta { display: flex; align-items: center; gap: 12px; margin-top: 12px; padding: 12px 16px; background: linear-gradient(135deg, #eff6ff, #f0fdf4); border: 1px solid #93c5fd; border-radius: 8px; }
    .threat-cta-icon { flex-shrink: 0; width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .threat-cta-text { flex: 1; font-size: 13px; line-height: 1.4; }
    .threat-cta-text strong { color: var(--primary); }
    .threat-cta-btn { flex-shrink: 0; padding: 8px 20px; background: var(--primary); color: #fff; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: none; transition: background 0.15s; }
    .threat-cta-btn:hover { background: var(--primary-dark, #0052cc); }
    .agents-panel { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; box-shadow: var(--shadow-sm); margin-bottom: 16px; }
    .agents-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .agents-panel-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .agents-panel-count { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; background: var(--gray-100); color: var(--muted); }
    .agents-grid { display: flex; gap: 10px; flex-wrap: wrap; }
    .agent-card { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; min-width: 200px; flex: 1; max-width: 340px; transition: all 0.2s; }
    .agent-card.active { border-color: var(--primary); background: #f0f4ff; }
    .agent-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .agent-dot.active { animation: pulse 2s infinite; }
    .agent-info { min-width: 0; flex: 1; }
    .agent-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .agent-session { font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .agent-model { font-size: 10px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .agent-status { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 600; flex-shrink: 0; }
    .agent-status.connected { background: #d1fae5; color: #065f46; }
    .agent-status.idle { background: var(--gray-100); color: var(--muted); }
    .agents-empty { font-size: 12px; color: var(--muted); padding: 8px 0; }
    @media (max-width: 768px) { .agent-card { min-width: 160px; } }

    /* Decisions Table */
    .section-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .section-title { font-size: 16px; font-weight: 700; }
    .section-sub { font-size: 12px; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; font-weight: 600; color: var(--muted); padding: 8px 12px; border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    tr:last-child td { border-bottom: none; }
    .pill { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; }
    .pill.allow { background: #d1fae5; color: #065f46; }
    .pill.deny { background: #fee2e2; color: #991b1b; }
    .pill.quarantine { background: #fef3c7; color: #92400e; }
    .pill.info { background: #dbeafe; color: #1e40af; }
    .conf-bar { width: 48px; height: 6px; background: var(--gray-200); border-radius: 3px; display: inline-block; vertical-align: middle; margin-left: 6px; overflow: hidden; }
    .conf-fill { height: 100%; border-radius: 3px; }
    .conf-fill.high { background: var(--success); }
    .conf-fill.mid { background: var(--warn); }
    .conf-fill.low { background: var(--danger); }
    .evidence-link { font-family: monospace; font-size: 11px; color: var(--primary); cursor: pointer; }
    .evidence-link:hover { text-decoration: underline; }

    /* Bottom Grid */
    .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 768px) { .bottom-grid { grid-template-columns: 1fr; } }

    .severity-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .sev-item { text-align: center; padding: 12px 8px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--border); }
    .sev-label { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
    .sev-value { font-size: 24px; font-weight: 800; }
    .sev-value.critical { color: #dc2626; }
    .sev-value.high { color: #ea580c; }
    .sev-value.medium { color: #f59e0b; }
    .sev-value.low { color: #22c55e; }
    .sev-bar { height: 4px; background: var(--gray-200); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .sev-fill { height: 100%; border-radius: 2px; }

    .action-btn { display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: var(--gray-50); border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--text); text-decoration: none; transition: all 0.15s; cursor: pointer; }
    .action-btn:hover { background: #fff; border-color: var(--primary); color: var(--primary); transform: translateX(4px); }
    .action-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
    .action-btn .action-desc { font-size: 12px; font-weight: 400; color: var(--muted); }
    .actions-stack { display: flex; flex-direction: column; gap: 10px; }

    .empty-hint { text-align: center; padding: 32px 16px; color: var(--muted); font-size: 13px; }
    .empty-hint a { font-weight: 600; }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="nav-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="MCP Gateway Suite">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
      </svg>
      MCP Gateway Suite
    </div>
    <div class="nav-links">
      <a href="settings_environments.html" class="nav-link">Environments</a>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="scans.html" class="nav-link">Scans</a>
      <a href="allowlist.html" class="nav-link">AllowList</a>
      <a href="web_sandbox.html" class="nav-link">Web Sandbox</a>
      <a href="audit_log.html" class="nav-link">Audit Log</a>
      <a href="evidence_pack.html" class="nav-link">Evidence Pack</a>
    </div>
    <div class="nav-status">
      <span class="status-dot"></span>
      Demo Mode
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <div>
        <h1 id="pageTitle">AI Gateway Dashboard</h1>
        <p class="muted" id="pageSubtitle">Scenario-based decisions, evidence, and policy enforcement</p>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <button type="button" id="demoBtn" style="padding: 10px 24px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(109,40,217,0.3);" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(109,40,217,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(109,40,217,0.3)'">
          <span style="font-size: 16px;">&#9654;</span> <span id="demoBtnText">Run Security Scenario</span>
        </button>
        <span style="font-size: 13px; color: var(--muted);">Language:</span>
        <div style="display: flex; gap: 4px;">
          <button type="button" class="lang-btn" id="langJa" data-lang="ja">JA</button>
          <button type="button" class="lang-btn" id="langEn" data-lang="en">EN</button>
        </div>
      </div>
    </div>

    <!-- Interactive Demo Banner -->
    <div id="demoBanner" style="background: linear-gradient(135deg, #dbeafe, #eff6ff); border: 1px solid #3b82f6; border-radius: 8px; padding: 10px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; font-size: 13px;">
      <span style="font-size: 16px;">&#9889;</span>
      <div>
        <b style="color: #1e40af;" id="demoBannerTitle">Interactive Demo</b>
        <span style="color: #1e3a5f;" id="demoBannerText"> &mdash; Showcasing Gemini 3 security analysis with pre-configured attack scenarios. <b>All 6 Gemini 3 API integrations are fully operational when GOOGLE_API_KEY is set.</b></span>
      </div>
    </div>

    <!-- Pipeline Execution Log (hidden until demo starts) -->
    <div id="pipelineLog" class="section-card" style="display: none; margin-bottom: 24px; border-left: 3px solid #8b5cf6;">
      <div class="section-header" style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 18px;" id="pipelineIcon">&#9881;</span>
          <span class="section-title" id="pipelineTitle">Pipeline Execution</span>
          <span id="pipelinePhase" style="font-size: 12px; background: #ede9fe; color: #6d28d9; padding: 2px 10px; border-radius: 10px; font-weight: 600;"></span>
        </div>
        <span id="pipelineCounter" style="font-size: 13px; color: var(--muted); font-weight: 600;"></span>
      </div>
      <div id="pipelineSteps" style="max-height: 320px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; line-height: 1.8; padding: 8px 0;"></div>
    </div>

    <!-- Gemini API Key (shared across all features) -->
    <div class="section-card" style="margin-bottom: 24px; padding: 16px 20px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
        <span style="font-size: 16px; font-weight: 700;" id="dashGeminiTitle">Gemini API Key</span>
        <span id="dashGeminiStatus" style="font-size: 11px; padding: 2px 10px; border-radius: 10px; font-weight: 600; background: var(--danger); color: #fff;">Not configured</span>
      </div>
      <p class="muted" style="margin-bottom: 10px; font-size: 13px;" id="dashGeminiDesc">Enter your Google AI Studio API key to enable Gemini-powered analysis across all features (Council, Scanner, RedTeam, Web Sandbox).</p>
      <form id="dashGeminiForm" style="display: flex; gap: 8px; align-items: center;">
        <input type="password" id="dashGeminiInput" placeholder="AIza..." autocomplete="off" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: monospace;">
        <button type="submit" id="dashGeminiBtn" style="padding: 8px 20px; background: var(--primary); color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">Set Key</button>
      </form>
      <div id="dashGeminiError" style="display: none; color: var(--danger); font-size: 13px; margin-top: 6px;"></div>
    </div>

    <!-- Threat Landscape Banner (E5 verified: arxiv 2509.24272 + mcp.so) -->
    <div class="threat-landscape" id="threatLandscape">
      <div class="threat-landscape-header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <span id="threatLandscapeTitle">MCP Ecosystem Threat Landscape</span>
        <span style="font-size: 10px; color: var(--muted); margin-left: auto;" id="threatLandscapeSource">Sources: mcp.so, Zhao et al. arxiv:2509.24272</span>
      </div>
      <div class="threat-stats-row">
        <div class="threat-stat">
          <div class="threat-stat-value" id="threatServers" data-target="17500">0</div>
          <div class="threat-stat-label" id="threatServersLabel">MCP Servers in Ecosystem</div>
        </div>
        <div class="threat-stat-divider"></div>
        <div class="threat-stat">
          <div class="threat-stat-value danger" id="threatAttackRate" data-target="94" data-suffix="%">0%</div>
          <div class="threat-stat-label" id="threatAttackRateLabel">Attack Success Rate</div>
        </div>
        <div class="threat-stat-divider"></div>
        <div class="threat-stat">
          <div class="threat-stat-value warning" id="threatDetection" data-target="3" data-suffix=".3%">0%</div>
          <div class="threat-stat-label" id="threatDetectionLabel">Detected by Existing Scanners</div>
        </div>
        <div class="threat-stat-divider"></div>
        <div class="threat-stat">
          <div class="threat-stat-value primary" id="threatGap">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Semantic
          </div>
          <div class="threat-stat-label" id="threatGapLabel">Gap: No Semantic Defense</div>
        </div>
      </div>
      <div class="threat-categories-row" style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; padding-top: 12px; border-top: 1px solid #fca5a5;">
        <span class="threat-cat-tag" id="threatCat1">Tool Shadowing</span>
        <span class="threat-cat-tag" id="threatCat2">Prompt Injection</span>
        <span class="threat-cat-tag" id="threatCat3">Signature Cloaking</span>
        <span class="threat-cat-tag" id="threatCat4">DGA Detection</span>
        <span class="threat-cat-tag" id="threatCat5">Brand Impersonation</span>
        <span class="threat-cat-tag" id="threatCat6">MCP Protocol Injection</span>
      </div>
      <!-- CTA: Problem → Solution bridge -->
      <div class="threat-cta" id="threatCta">
        <div class="threat-cta-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>
        <div class="threat-cta-text">
          <span id="threatCtaText"><strong>MCP Gateway</strong> closes this gap. Gemini 3 reasons about tool intent, detects semantic manipulation, and catches threats that pattern matching misses &mdash; covering all 6 attack categories above.</span>
        </div>
        <a class="threat-cta-btn" href="web_sandbox.html" id="threatCtaBtn">Try Web Sandbox &rarr;</a>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card blue">
        <div class="kpi-label" id="kpiTotalLabel">Total Requests</div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub" id="kpiTotalSub">MCP tool calls inspected</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label" id="kpiAllowLabel">Allowed</div>
        <div class="kpi-value green" id="kpiAllow">0</div>
        <div class="kpi-sub" id="kpiAllowSub">passed policy checks</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label" id="kpiBlockLabel">Block Rate</div>
        <div class="kpi-value red" id="kpiBlock">0%</div>
        <div class="kpi-sub" id="kpiBlockSub">denied or quarantined</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label" id="kpiCouncilLabel">AI Council</div>
        <div class="kpi-value blue" id="kpiCouncil">0</div>
        <div class="kpi-sub" id="kpiCouncilSub">Gemini-powered verdicts</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label" id="kpiPolicyLabel">Policy</div>
        <div class="kpi-value" id="kpiPolicy" style="font-size: 18px;">-</div>
        <div class="kpi-sub" id="kpiPolicySub">bundle status</div>
      </div>
    </div>

    <!-- Connected Agents Panel -->
    <div class="agents-panel" id="agentsPanel">
      <div class="agents-panel-header">
        <div class="agents-panel-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="4" cy="8" r="2" opacity="0.4"/><circle cx="20" cy="8" r="2" opacity="0.4"/></svg>
          <span id="agentsPanelTitle">Scenario Agents</span>
          <span class="agents-panel-count" id="agentsPanelCount">0</span>
        </div>
        <span style="font-size: 11px; color: var(--muted);" id="agentsPanelHint">Run pipeline to connect agents</span>
      </div>
      <div class="agents-grid" id="agentsGrid">
        <div class="agents-empty" id="agentsEmpty">No agents in scenario. Click <b>Run Security Scenario</b> to start a multi-agent security scenario.</div>
      </div>
    </div>

    <!-- Gateway Flow Diagram -->
    <div class="flow-card">
      <div class="flow-row">
        <div class="flow-box">
          <div class="flow-box-title" id="flowAgentTitle">Agent Requests</div>
          <div class="flow-box-sub" id="flowAgentSub">MCP Clients</div>
          <div class="flow-box-metric" id="flowAgentMetric">0</div>
          <div class="flow-tags" id="flowAgentDots" style="margin-top: 8px;"></div>
        </div>
        <div class="flow-arrow active">&#10132;</div>
        <div class="flow-box gateway">
          <div class="flow-box-title" id="flowGatewayTitle">MCP Gateway</div>
          <div class="flow-box-sub">Auth &middot; Inspect &middot; Route</div>
          <div class="flow-tags" style="margin-top: 12px;">
            <span class="flow-tag green" id="flowGeminiTag">Gemini 3</span>
            <span class="flow-tag amber" id="flowPolicyTag">Policy Engine</span>
          </div>
        </div>
        <div class="flow-arrow active">&#10132;</div>
        <div class="flow-box">
          <div class="flow-box-title" id="flowToolsTitle">AI Tools & APIs</div>
          <div class="flow-box-sub" id="flowToolsSub">Upstream LLM</div>
          <div class="flow-tags" style="margin-top: 10px;">
            <span class="flow-tag green" id="flowAllowed">0 Allowed</span>
            <span class="flow-tag red" id="flowBlocked">0 Blocked</span>
            <span class="flow-tag amber" id="flowQuarantined">0 Quarantined</span>
            <span class="flow-tag amber" id="flowDlp" style="display:none">0 DLP</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Decisions -->
    <div class="section-card">
      <div class="section-header">
        <div>
          <div class="section-title" id="decisionsTitle">Recent Decisions</div>
          <div class="section-sub" id="decisionsSub">AI Council verdicts and policy enforcement actions</div>
        </div>
        <a href="audit_log.html" style="font-size: 13px; font-weight: 600;" id="viewAllLink">View all &rarr;</a>
      </div>
      <table id="decisionsTable">
        <thead id="decisionsThead">
          <tr><th>Time</th><th>Decision</th><th>Confidence</th><th>Finding</th><th>Evidence</th></tr>
        </thead>
        <tbody id="decisionsBody"></tbody>
      </table>
      <div class="empty-hint" id="decisionsEmpty">
        No decisions yet. <a href="web_sandbox.html">Run your first scan</a> to see AI-powered verdicts here.
      </div>
    </div>

    <!-- SSOT / Shadow Audit Status -->
    <div class="section-card" id="ssotCard" style="margin-bottom: 16px;">
      <div class="section-header">
        <div>
          <div class="section-title" id="ssotTitle">Evidence Chain Integrity</div>
          <div class="section-sub" id="ssotSub">SSOT verification and shadow audit status</div>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-top: 12px;" id="ssotGrid">
        <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200);">
          <div style="width: 10px; height: 10px; border-radius: 50%;" id="ssotChainDot"></div>
          <div><div style="font-size: 12px; font-weight: 600;" id="ssotChainLabel">Chain Hash</div><div style="font-size: 11px; color: var(--gray-600);" id="ssotChainStatus">-</div></div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200);">
          <div style="width: 10px; height: 10px; border-radius: 50%;" id="ssotBundleDot"></div>
          <div><div style="font-size: 12px; font-weight: 600;" id="ssotBundleLabel">Policy Bundle</div><div style="font-size: 11px; color: var(--gray-600);" id="ssotBundleStatus">-</div></div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200);">
          <div style="width: 10px; height: 10px; border-radius: 50%;" id="ssotSigDot"></div>
          <div><div style="font-size: 12px; font-weight: 600;" id="ssotSigLabel">Signature</div><div style="font-size: 11px; color: var(--gray-600);" id="ssotSigStatus">-</div></div>
        </div>
      </div>
    </div>

    <!-- Attack Detection Timeline -->
    <div class="section-card" id="attackCard" style="margin-bottom: 16px;">
      <div class="section-header">
        <div>
          <div class="section-title" id="attackTitle">Attack Detection</div>
          <div class="section-sub" id="attackSub">Signature Cloaking, Bait-and-Switch, and Tool Shadowing detection</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="font-size:13px;font-weight:700;color:var(--danger);" id="attackCountBadge">0 threats</span>
        </div>
      </div>
      <div id="attackTimeline" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;"></div>
      <div class="empty-hint" id="attackEmpty" style="display:none;">
        No attack patterns detected. Advanced detectors are monitoring for signature cloaking, bait-and-switch, and tool shadowing.
      </div>
    </div>

    <!-- Bottom Grid: Severity + Quick Actions -->
    <div class="bottom-grid">
      <div class="section-card">
        <div class="section-title" id="severityTitle" style="margin-bottom: 16px;">Severity Breakdown</div>
        <div class="severity-grid">
          <div class="sev-item"><div class="sev-label">Critical</div><div class="sev-value critical" id="sevCritical">0</div><div class="sev-bar"><div class="sev-fill" id="sevCriticalBar" style="width:0%;background:#dc2626;"></div></div></div>
          <div class="sev-item"><div class="sev-label">High</div><div class="sev-value high" id="sevHigh">0</div><div class="sev-bar"><div class="sev-fill" id="sevHighBar" style="width:0%;background:#ea580c;"></div></div></div>
          <div class="sev-item"><div class="sev-label">Medium</div><div class="sev-value medium" id="sevMedium">0</div><div class="sev-bar"><div class="sev-fill" id="sevMediumBar" style="width:0%;background:#f59e0b;"></div></div></div>
          <div class="sev-item"><div class="sev-label">Low</div><div class="sev-value low" id="sevLow">0</div><div class="sev-bar"><div class="sev-fill" id="sevLowBar" style="width:0%;background:#22c55e;"></div></div></div>
        </div>
      </div>
      <div class="section-card">
        <div class="section-title" id="actionsTitle" style="margin-bottom: 16px;">Quick Actions</div>
        <div class="actions-stack">
          <a href="web_sandbox.html" class="action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
            <div><div id="actionScan">Scan a URL</div><div class="action-desc" id="actionScanDesc">Analyze a web page with Causal Web Sandbox</div></div>
          </a>
          <a href="audit_log.html" class="action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            <div><div id="actionAudit">View Evidence Trail</div><div class="action-desc" id="actionAuditDesc">Browse structured audit log with evidence IDs</div></div>
          </a>
          <a href="settings_environments.html" class="action-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
            <div><div id="actionPolicy">Configure Policies</div><div class="action-desc" id="actionPolicyDesc">Manage upstream LLM and policy profiles</div></div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Self-Tuning Suggestion Card -->
  <div style="max-width:1280px;margin:24px auto 0;padding:0 24px;">
    <div class="section-card" id="selfTuningCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div>
          <div class="section-title" id="selfTuningTitle">Self-Tuning Weights</div>
          <div class="section-sub" id="selfTuningSub">AI Council weight optimization based on historical decisions</div>
        </div>
        <span class="pill info" style="font-size:10px;">Beta</span>
      </div>
      <div id="selfTuningContent" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div>
          <div style="font-size:12px;font-weight:600;color:var(--muted);margin-bottom:8px;" id="stCurrentLabel">Current Weights</div>
          <div id="stCurrentBars"></div>
        </div>
        <div>
          <div style="font-size:12px;font-weight:600;color:var(--muted);margin-bottom:8px;" id="stProposedLabel">Proposed Weights</div>
          <div id="stProposedBars"></div>
        </div>
      </div>
      <div id="stRationale" style="margin-top:12px;font-size:13px;color:var(--gray-700);"></div>
      <div id="stImpact" style="margin-top:4px;font-size:12px;color:var(--muted);font-style:italic;"></div>
      <div style="margin-top:16px;display:flex;gap:8px;">
        <button id="stApplyBtn" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer;">Apply Suggestion</button>
        <button id="stRefreshBtn" style="padding:8px 16px;background:var(--gray-100);color:var(--gray-700);border:1px solid var(--gray-300);border-radius:6px;font-size:13px;cursor:pointer;">Refresh</button>
      </div>
    </div>
  </div>

  <script src="mock_data.js"></script>
  <script src="api_client.js"></script>
  <script>
    (function () {
      if (!window.location || !window.location.pathname) return;
      const currentFile = window.location.pathname.split('/').pop() || 'dashboard.html';
      document.querySelectorAll('.nav-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href === currentFile || (currentFile === '' && href === 'dashboard.html')) link.classList.add('active');
        else link.classList.remove('active');
      });
    })();
  </script>
  <script>
    function escapeHtml(str) { if (str == null) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    const I18N = {
      en: {
        pageTitle: 'AI Gateway Dashboard',
        pageSubtitle: 'Scenario-based decisions, evidence, and policy enforcement',
        kpiTotal: 'Total Requests', kpiTotalSub: 'MCP tool calls inspected',
        kpiAllow: 'Allowed', kpiAllowSub: 'passed policy checks',
        kpiBlock: 'Block Rate', kpiBlockSub: 'denied or quarantined',
        kpiCouncil: 'AI Council', kpiCouncilSub: 'Gemini-powered verdicts',
        kpiPolicy: 'Policy', kpiPolicySub: 'bundle status',
        flowAgent: 'Agent Requests', flowAgentSub: 'MCP Clients',
        flowGateway: 'MCP Gateway', flowTools: 'AI Tools & APIs', flowToolsSub: 'Upstream LLM',
        flowAllowed: 'Allowed', flowBlocked: 'Blocked', flowQuarantined: 'Quarantined',
        decisionsTitle: 'Recent Decisions', decisionsSub: 'AI Council verdicts and policy enforcement actions',
        viewAll: 'View all', thTime: 'Time', thDecision: 'Decision', thConfidence: 'Confidence', thFinding: 'Finding', thEvidence: 'Evidence',
        decisionsEmpty: 'No decisions yet.', decisionsEmptyLink: 'Run your first scan',
        decisionsEmptyTail: ' to see AI-powered verdicts here.',
        severityTitle: 'Severity Breakdown', actionsTitle: 'Quick Actions',
        actionScan: 'Scan a URL', actionScanDesc: 'Analyze a web page with Causal Web Sandbox',
        actionAudit: 'View Evidence Trail', actionAuditDesc: 'Browse structured audit log with evidence IDs',
        actionPolicy: 'Configure Policies', actionPolicyDesc: 'Manage upstream LLM and policy profiles',
        policyVerified: 'Verified', policyPresent: 'Present', policyMissing: 'Missing', policyNA: 'N/A',
        ssotTitle: 'Evidence Chain Integrity', ssotSub: 'SSOT verification and shadow audit status',
        ssotPass: 'Verified', ssotFail: 'Not verified', ssotPresent: 'Present', ssotMissing: 'Missing', ssotSigned: 'Signed', ssotUnsigned: 'Not signed',
        demoBtn: 'Run Security Scenario',
        agentsTitle: 'Scenario Agents', agentsHint: 'Run scenario to connect agents',
        agentsEmpty: 'No agents in scenario. Click Run Security Scenario to start a multi-agent security scenario.',
        threatTitle: 'MCP Ecosystem Threat Landscape',
        threatSource: 'Sources: mcp.so, Zhao et al. arxiv:2509.24272',
        threatServers: 'MCP Servers in Ecosystem',
        threatAttackRate: 'Attack Success Rate',
        threatDetection: 'Detected by Existing Scanners',
        threatGap: 'Gap: No Semantic Defense',
        threatCtaText: '<strong>MCP Gateway</strong> closes this gap. Gemini 3 reasons about tool intent, detects semantic manipulation, and catches threats that pattern matching misses \u2014 covering all 6 attack categories above.',
        threatCtaBtn: 'Try Web Sandbox \u2192',
        demoBannerTitle: 'Interactive Demo',
        demoBannerText: ' \u2014 Showcasing Gemini 3 security analysis with pre-configured attack scenarios. <b>All 6 Gemini 3 API integrations are fully operational when GOOGLE_API_KEY is set.</b>',
        attackTitle: 'Attack Detection',
        attackSub: 'Signature Cloaking, Bait-and-Switch, and Tool Shadowing detection',
        attackCount: ' threats',
        attackEmpty: 'No attack patterns detected. Advanced detectors are monitoring for signature cloaking, bait-and-switch, and tool shadowing.',
        attackCodeCloaking: 'Signature Cloaking', attackCodeBaitSwitch: 'Bait & Switch', attackCodeShadowing: 'Tool Shadowing',
        attackBlocked: 'BLOCKED', attackFlagged: 'FLAGGED',
        sevCritical: 'Critical', sevHigh: 'High', sevMedium: 'Medium', sevLow: 'Low',
        geminiTitle: 'Gemini API Key',
        geminiNotConfigured: 'Not configured', geminiConfigured: '\u2713 Configured',
        geminiDesc: 'Enter your Google AI Studio API key to enable Gemini-powered analysis across all features (Council, Scanner, RedTeam, Web Sandbox).',
        geminiDescActive: 'Gemini API key is active. All AI-powered features are enabled.',
        geminiSetKey: 'Set Key', geminiUpdateKey: 'Update Key',
      },
      ja: {
        pageTitle: 'AI Gateway Dashboard',
        pageSubtitle: 'シナリオベースの判定・証跡・ポリシー適用',
        kpiTotal: '総リクエスト', kpiTotalSub: '検査済み MCP ツール呼び出し',
        kpiAllow: '許可', kpiAllowSub: 'ポリシーチェック通過',
        kpiBlock: 'ブロック率', kpiBlockSub: '拒否またはクォランティン',
        kpiCouncil: 'AI Council', kpiCouncilSub: 'Gemini 構造化判定',
        kpiPolicy: 'ポリシー', kpiPolicySub: 'バンドル状態',
        flowAgent: 'エージェント要求', flowAgentSub: 'MCP クライアント',
        flowGateway: 'MCP ゲートウェイ', flowTools: 'AI ツール & API', flowToolsSub: 'アップストリーム LLM',
        flowAllowed: '許可', flowBlocked: 'ブロック', flowQuarantined: '隔離',
        decisionsTitle: '最近の判定', decisionsSub: 'AI Council 判定とポリシー適用アクション',
        viewAll: 'すべて表示', thTime: '時刻', thDecision: '判定', thConfidence: '信頼度', thFinding: '検出内容', thEvidence: '証跡',
        decisionsEmpty: '判定はまだありません。', decisionsEmptyLink: '最初のスキャンを実行',
        decisionsEmptyTail: 'して、AIによる判定を確認してください。',
        severityTitle: '深刻度内訳', actionsTitle: 'クイックアクション',
        actionScan: 'URL をスキャン', actionScanDesc: 'Causal Web Sandbox でページを分析',
        actionAudit: '証跡トレイルを表示', actionAuditDesc: '構造化された監査ログと証跡 ID を閲覧',
        actionPolicy: 'ポリシーを設定', actionPolicyDesc: 'アップストリーム LLM とポリシープロファイルを管理',
        policyVerified: '検証済', policyPresent: '存在', policyMissing: '未設定', policyNA: 'N/A',
        ssotTitle: '証跡チェーン完全性', ssotSub: 'SSOT検証とシャドー監査の状態',
        ssotPass: '検証済', ssotFail: '未検証', ssotPresent: '存在', ssotMissing: '未設定', ssotSigned: '署名済', ssotUnsigned: '未署名',
        demoBtn: 'セキュリティシナリオ実行',
        agentsTitle: 'シナリオエージェント', agentsHint: 'シナリオ実行でエージェント接続',
        agentsEmpty: 'シナリオ未開始。セキュリティシナリオ実行で開始してください。',
        threatTitle: 'MCP エコシステム脅威状況',
        threatSource: '出典: mcp.so, Zhao et al. arxiv:2509.24272',
        threatServers: 'エコシステム内 MCP サーバー数',
        threatAttackRate: '攻撃成功率',
        threatDetection: '既存スキャナの検出率',
        threatGap: 'ギャップ: セマンティック防御なし',
        threatCtaText: '<strong>MCP Gateway</strong> がこのギャップを埋めます。Gemini 3 がツールの意図を推論し、セマンティック操作を検出。パターンマッチングでは見逃す脅威を上記6カテゴリすべてでカバーします。',
        threatCtaBtn: 'Web Sandbox を試す \u2192',
        demoBannerTitle: 'インタラクティブデモ',
        demoBannerText: ' \u2014 Gemini 3 によるセキュリティ分析を事前設定された攻撃シナリオでデモンストレーション。<b>GOOGLE_API_KEY を設定すると、6つの Gemini 3 API 統合がすべて稼働します。</b>',
        attackTitle: '攻撃検出',
        attackSub: 'Signature Cloaking・Bait-and-Switch・Tool Shadowing の検出',
        attackCount: ' 件の脅威',
        attackEmpty: '攻撃パターンは検出されていません。高度な検出器が Signature Cloaking・Bait-and-Switch・Tool Shadowing を監視中です。',
        attackCodeCloaking: '署名偽装', attackCodeBaitSwitch: 'おとり切替', attackCodeShadowing: 'ツール偽装',
        attackBlocked: 'ブロック済', attackFlagged: 'フラグ付',
        sevCritical: '致命的', sevHigh: '高', sevMedium: '中', sevLow: '低',
        geminiTitle: 'Gemini API キー',
        geminiNotConfigured: '未設定', geminiConfigured: '\u2713 設定済',
        geminiDesc: 'Google AI Studio の API キーを入力して全機能（Council・Scanner・RedTeam・Web Sandbox）の Gemini 分析を有効化。',
        geminiDescActive: 'Gemini API キーが有効です。全 AI 分析機能が利用可能です。',
        geminiSetKey: 'キー設定', geminiUpdateKey: 'キー更新',
      }
    };

    const LANG_KEY = 'suite_language';
    function getLang() { try { return localStorage.getItem(LANG_KEY) || 'en'; } catch(e) { return 'en'; } }
    function setLang(l) { try { localStorage.setItem(LANG_KEY, l); } catch(e) {} }

    function applyI18n(lang) {
      var d = I18N[lang] || I18N.en;
      var el = function(id) { return document.getElementById(id); };
      if (el('pageTitle')) el('pageTitle').textContent = d.pageTitle;
      if (el('pageSubtitle')) el('pageSubtitle').textContent = d.pageSubtitle;
      if (el('kpiTotalLabel')) el('kpiTotalLabel').textContent = d.kpiTotal;
      if (el('kpiTotalSub')) el('kpiTotalSub').textContent = d.kpiTotalSub;
      if (el('kpiAllowLabel')) el('kpiAllowLabel').textContent = d.kpiAllow;
      if (el('kpiAllowSub')) el('kpiAllowSub').textContent = d.kpiAllowSub;
      if (el('kpiBlockLabel')) el('kpiBlockLabel').textContent = d.kpiBlock;
      if (el('kpiBlockSub')) el('kpiBlockSub').textContent = d.kpiBlockSub;
      if (el('kpiCouncilLabel')) el('kpiCouncilLabel').textContent = d.kpiCouncil;
      if (el('kpiCouncilSub')) el('kpiCouncilSub').textContent = d.kpiCouncilSub;
      if (el('kpiPolicyLabel')) el('kpiPolicyLabel').textContent = d.kpiPolicy;
      if (el('kpiPolicySub')) el('kpiPolicySub').textContent = d.kpiPolicySub;
      if (el('flowAgentTitle')) el('flowAgentTitle').textContent = d.flowAgent;
      if (el('flowAgentSub')) el('flowAgentSub').textContent = d.flowAgentSub;
      if (el('flowGatewayTitle')) el('flowGatewayTitle').textContent = d.flowGateway;
      if (el('flowToolsTitle')) el('flowToolsTitle').textContent = d.flowTools;
      if (el('flowToolsSub')) el('flowToolsSub').textContent = d.flowToolsSub;
      if (el('decisionsTitle')) el('decisionsTitle').textContent = d.decisionsTitle;
      if (el('decisionsSub')) el('decisionsSub').textContent = d.decisionsSub;
      if (el('viewAllLink')) el('viewAllLink').innerHTML = escapeHtml(d.viewAll) + ' &rarr;';
      if (el('ssotTitle')) el('ssotTitle').textContent = d.ssotTitle;
      if (el('ssotSub')) el('ssotSub').textContent = d.ssotSub;
      if (el('severityTitle')) el('severityTitle').textContent = d.severityTitle;
      if (el('actionsTitle')) el('actionsTitle').textContent = d.actionsTitle;
      if (el('actionScan')) el('actionScan').textContent = d.actionScan;
      if (el('actionScanDesc')) el('actionScanDesc').textContent = d.actionScanDesc;
      if (el('actionAudit')) el('actionAudit').textContent = d.actionAudit;
      if (el('actionAuditDesc')) el('actionAuditDesc').textContent = d.actionAuditDesc;
      if (el('actionPolicy')) el('actionPolicy').textContent = d.actionPolicy;
      if (el('actionPolicyDesc')) el('actionPolicyDesc').textContent = d.actionPolicyDesc;
      var th = el('decisionsThead');
      if (th) th.innerHTML = '<tr><th>' + [d.thTime, d.thDecision, d.thConfidence, d.thFinding, d.thEvidence].map(escapeHtml).join('</th><th>') + '</th></tr>';
      if (el('decisionsEmpty')) el('decisionsEmpty').innerHTML = escapeHtml(d.decisionsEmpty) + ' <a href="web_sandbox.html">' + escapeHtml(d.decisionsEmptyLink) + '</a>' + escapeHtml(d.decisionsEmptyTail);
      if (el('demoBtnText')) el('demoBtnText').textContent = d.demoBtn;
      if (el('threatLandscapeTitle')) el('threatLandscapeTitle').textContent = d.threatTitle || 'MCP Ecosystem Threat Landscape';
      if (el('threatLandscapeSource')) el('threatLandscapeSource').textContent = d.threatSource || '';
      if (el('threatServersLabel')) el('threatServersLabel').textContent = d.threatServers || '';
      if (el('threatAttackRateLabel')) el('threatAttackRateLabel').textContent = d.threatAttackRate || '';
      if (el('threatDetectionLabel')) el('threatDetectionLabel').textContent = d.threatDetection || '';
      if (el('threatGapLabel')) el('threatGapLabel').textContent = d.threatGap || '';
      if (el('threatCtaText') && d.threatCtaText) el('threatCtaText').innerHTML = d.threatCtaText;
      if (el('threatCtaBtn') && d.threatCtaBtn) el('threatCtaBtn').textContent = d.threatCtaBtn;
      if (el('agentsPanelTitle')) el('agentsPanelTitle').textContent = d.agentsTitle || 'Connected Agents';
      if (el('agentsPanelHint') && _connectedAgents.length === 0) el('agentsPanelHint').textContent = d.agentsHint || 'Run pipeline to connect agents';
      // Demo banner
      if (el('demoBannerTitle') && d.demoBannerTitle) el('demoBannerTitle').textContent = d.demoBannerTitle;
      if (el('demoBannerText') && d.demoBannerText) el('demoBannerText').innerHTML = d.demoBannerText;
      // Attack detection
      if (el('attackTitle') && d.attackTitle) el('attackTitle').textContent = d.attackTitle;
      if (el('attackSub') && d.attackSub) el('attackSub').textContent = d.attackSub;
      if (el('attackEmpty') && d.attackEmpty) el('attackEmpty').textContent = d.attackEmpty;
      // Severity labels
      var sevLabels = document.querySelectorAll('.sev-label');
      var sevKeys = [d.sevCritical, d.sevHigh, d.sevMedium, d.sevLow];
      sevLabels.forEach(function(lbl, i) { if (sevKeys[i]) lbl.textContent = sevKeys[i]; });
      // Gemini API key section
      if (el('dashGeminiTitle') && d.geminiTitle) el('dashGeminiTitle').textContent = d.geminiTitle;
      if (window._geminiRefreshI18n) window._geminiRefreshI18n();
      // lang buttons
      var ja = el('langJa'), en = el('langEn');
      if (ja) ja.classList.toggle('active', lang === 'ja');
      if (en) en.classList.toggle('active', lang === 'en');
    }

    function decisionPill(type) {
      var t = String(type || '').toLowerCase();
      if (t.includes('deny') || t.includes('block')) return '<span class="pill deny">DENY</span>';
      if (t.includes('quarantine') || t.includes('warn')) return '<span class="pill quarantine">QUARANTINE</span>';
      return '<span class="pill allow">ALLOW</span>';
    }

    function confBar(val) {
      var pct = typeof val === 'number' ? Math.round(val * 100) : (parseInt(val) || 0);
      var cls = pct >= 70 ? 'high' : pct >= 40 ? 'mid' : 'low';
      return pct + '%<div class="conf-bar"><div class="conf-fill ' + cls + '" style="width:' + pct + '%;"></div></div>';
    }

    function formatTs(ts) {
      if (!ts) return '-';
      try { var d = new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch(e) { return ts; }
    }

    function getPolicyStatus(shadow, allowlistStatus) {
      var d = I18N[getLang()] || I18N.en;
      var source = allowlistStatus || shadow || {};
      var sig = String(source.policy_bundle_signature_status || '');
      if (sig.startsWith('verified')) return { text: d.policyVerified, cls: 'green' };
      var present = source.policy_bundle_present_ok;
      if (present === true) return { text: d.policyPresent, cls: 'blue' };
      if (present === false) return { text: d.policyMissing, cls: 'red' };
      return { text: d.policyNA, cls: '' };
    }

    async function init() {
      var apiClient = window.apiClient;
      if (!apiClient) return;
      var lang = getLang();
      var d = I18N[lang] || I18N.en;

      // Fetch data in parallel
      var summaryP = apiClient.fetchDashboardSummary ? apiClient.fetchDashboardSummary() : Promise.resolve(null);
      var allowStatusP = apiClient.fetchAllowlistStatus ? apiClient.fetchAllowlistStatus() : Promise.resolve(null);
      var auditP = apiClient.fetchControlAudit ? apiClient.fetchControlAudit(10) : Promise.resolve(null);
      var webVerdictsP = apiClient.fetchWebSandboxVerdicts ? apiClient.fetchWebSandboxVerdicts() : Promise.resolve(null);

      var results = await Promise.all([summaryP, allowStatusP, auditP, webVerdictsP]);
      var summary = results[0];
      var allowlistStatus = results[1];
      var auditRes = results[2];
      var webVerdicts = results[3];

      // KPI Cards
      var allow = (summary && summary.allowlist) || {};
      var scans = (summary && summary.scans) || {};
      var council = (summary && summary.council) || {};
      var total = (allow.total || 0) + (scans.total || 0) + (council.total || 0);
      var denied = (allow.deny || 0) + (allow.quarantine || 0);
      var allowed = (allow.active || 0);
      var blockRate = total > 0 ? ((denied / total) * 100).toFixed(1) : '0';

      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiAllow').textContent = allowed;
      document.getElementById('kpiBlock').textContent = blockRate + '%';
      document.getElementById('kpiCouncil').textContent = council.total || 0;

      // Policy status (fallback to mock shadow_audit when live data missing)
      var shadowAudit = (summary && summary.shadow_audit) || null;
      if (!shadowAudit && window.suiteScanData && window.suiteScanData.dashboard_summary) {
        shadowAudit = window.suiteScanData.dashboard_summary.shadow_audit;
      }
      var policyStatus = getPolicyStatus(shadowAudit, allowlistStatus);
      var policyEl = document.getElementById('kpiPolicy');
      policyEl.textContent = policyStatus.text;
      if (policyStatus.cls) policyEl.className = 'kpi-value ' + policyStatus.cls;

      // Flow diagram
      document.getElementById('flowAgentMetric').textContent = total;
      document.getElementById('flowAllowed').textContent = allowed + ' ' + d.flowAllowed;
      document.getElementById('flowBlocked').textContent = (allow.deny || 0) + ' ' + d.flowBlocked;
      document.getElementById('flowQuarantined').textContent = (allow.quarantine || 0) + ' ' + d.flowQuarantined;

      // SSOT / Shadow Audit Status (reuse shadowAudit with mock fallback)
      var shadow = shadowAudit || {};
      var aStatus = allowlistStatus || {};
      function ssotDot(ok, elId) {
        var dot = document.getElementById(elId);
        if (dot) dot.style.background = ok ? '#22c55e' : ok === false ? '#ef4444' : '#d1d5db';
      }
      ssotDot(shadow.chain_ok, 'ssotChainDot');
      ssotDot(shadow.policy_bundle_present_ok || aStatus.policy_bundle_present_ok, 'ssotBundleDot');
      var sigOk = String(shadow.policy_bundle_signature_status || aStatus.policy_bundle_signature_status || '').startsWith('verified');
      ssotDot(sigOk || null, 'ssotSigDot');
      var chainSt = document.getElementById('ssotChainStatus');
      if (chainSt) chainSt.textContent = shadow.chain_ok ? (d.ssotPass || 'Verified') : (d.ssotFail || 'Not verified');
      var bundleSt = document.getElementById('ssotBundleStatus');
      if (bundleSt) bundleSt.textContent = (shadow.policy_bundle_present_ok || aStatus.policy_bundle_present_ok) ? (d.ssotPresent || 'Present') : (d.ssotMissing || 'Missing');
      var sigSt = document.getElementById('ssotSigStatus');
      if (sigSt) sigSt.textContent = sigOk ? (d.ssotSigned || 'Signed') : (d.ssotUnsigned || 'Not signed');

      // Severity
      var sev = scans.severity_counts || {};
      var sevTotal = (sev.critical || 0) + (sev.high || 0) + (sev.medium || 0) + (sev.low || 0) || 1;
      document.getElementById('sevCritical').textContent = sev.critical || 0;
      document.getElementById('sevHigh').textContent = sev.high || 0;
      document.getElementById('sevMedium').textContent = sev.medium || 0;
      document.getElementById('sevLow').textContent = sev.low || 0;
      document.getElementById('sevCriticalBar').style.width = ((sev.critical || 0) / sevTotal * 100) + '%';
      document.getElementById('sevHighBar').style.width = ((sev.high || 0) / sevTotal * 100) + '%';
      document.getElementById('sevMediumBar').style.width = ((sev.medium || 0) / sevTotal * 100) + '%';
      document.getElementById('sevLowBar').style.width = ((sev.low || 0) / sevTotal * 100) + '%';

      // Attack Detection Timeline: merge audit_log block events + demo attack_detections
      var audit = (auditRes && auditRes.ok && Array.isArray(auditRes.data)) ? auditRes.data : [];
      var attacks = [];
      // 1) Extract real block/quarantine events from audit log as attack signals
      if (audit.length > 0) {
        audit.forEach(function(ev) {
          if (ev.detail && (ev.detail.decision === 'deny' || ev.detail.decision === 'block' || ev.detail.decision === 'quarantine')) {
            attacks.push({
              ts: ev.ts,
              code: ev.type === 'source_sink_check' ? 'tool_shadowing' : ev.type === 'openai_proxy_block' ? 'bait_and_switch' : 'signature_cloaking',
              severity: 'critical',
              tool_name: (ev.detail && ev.detail.tool_name) || ev.summary || '',
              server: (ev.detail && ev.detail.server_id) || '',
              message: ev.summary || '',
              confidence: (ev.detail && typeof ev.detail.confidence === 'number') ? ev.detail.confidence : 0.80,
              status: 'blocked'
            });
          }
        });
      }
      // 2) Supplement with demo data if no live attacks found
      if (attacks.length === 0 && window.suiteScanData && Array.isArray(window.suiteScanData.attack_detections)) {
        attacks = window.suiteScanData.attack_detections;
        if (typeof showMockBadge === 'function') showMockBadge();
      }
      var attackTimeline = document.getElementById('attackTimeline');
      var attackEmpty = document.getElementById('attackEmpty');
      var attackBadge = document.getElementById('attackCountBadge');
      if (attackBadge) attackBadge.textContent = attacks.length + (d.attackCount || ' threats');
      if (attackBadge) attackBadge.style.color = attacks.length > 0 ? 'var(--danger)' : 'var(--success)';
      if (attacks.length > 0 && attackTimeline) {
        var codeLabels = { signature_cloaking: d.attackCodeCloaking || 'Signature Cloaking', bait_and_switch: d.attackCodeBaitSwitch || 'Bait & Switch', tool_shadowing: d.attackCodeShadowing || 'Tool Shadowing' };
        var codeColors = { signature_cloaking: '#dc2626', bait_and_switch: '#ea580c', tool_shadowing: '#7c3aed' };
        attackTimeline.innerHTML = attacks.map(function(a) {
          var color = codeColors[a.code] || '#ef4444';
          var label = codeLabels[a.code] || a.code;
          var statusPill = a.status === 'blocked'
            ? '<span style="background:#fee2e2;color:#991b1b;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">' + escapeHtml(d.attackBlocked || 'BLOCKED') + '</span>'
            : '<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">' + escapeHtml(d.attackFlagged || 'FLAGGED') + '</span>';
          // Enhanced message rendering with visual diffs
          var msgHtml = '';
          if (a.code === 'tool_shadowing' && a.message) {
            // Parse: "Suspiciously similar to well-known tool 'read_file' (similarity=88%)"
            var match = a.message.match(/similar to.*?'(\w+)'/);
            var legit = match ? match[1] : '';
            if (legit && typeof charDiff === 'function') {
              var df = charDiff(a.tool_name, legit);
              msgHtml = '<div style="font-size:12px;color:var(--gray-700);"><code style="background:#fee2e2;padding:2px 6px;border-radius:4px;font-family:monospace">' + df.actual + '</code> <span style="color:var(--muted)">mimics</span> <code style="background:#d1fae5;padding:2px 6px;border-radius:4px;font-family:monospace">' + df.legit + '</code></div>';
            } else {
              msgHtml = '<div style="font-size:12px;color:var(--gray-700);">' + escapeHtml(a.message) + '</div>';
            }
          } else if (a.code === 'signature_cloaking' && a.message) {
            // Parse: "Description changed X%: 'old' -> 'new'"
            var parts = a.message.split("'");
            if (parts.length >= 4) {
              msgHtml = '<div style="font-size:12px;color:var(--gray-700);">'
                + '<span style="text-decoration:line-through;color:var(--muted)">"' + escapeHtml(parts[1]) + '"</span>'
                + ' <span style="color:#dc2626;font-weight:600">&rarr;</span> '
                + '<span style="color:#dc2626;font-weight:600">"' + escapeHtml(parts[3]) + '"</span>'
                + '</div>';
            } else {
              msgHtml = '<div style="font-size:12px;color:var(--gray-700);">' + escapeHtml(a.message) + '</div>';
            }
          } else if (a.code === 'bait_and_switch' && a.message) {
            // Highlight sensitive field names in the message
            var msg = escapeHtml(a.message);
            msg = msg.replace(/\b(password|api_key|session_id|credential|token|secret)\b/gi, '<span style="background:#fee2e2;color:#991b1b;padding:0 4px;border-radius:2px;font-weight:600;font-family:monospace">$1</span>');
            msgHtml = '<div style="font-size:12px;color:var(--gray-700);">' + msg + '</div>';
          } else {
            msgHtml = '<div style="font-size:12px;color:var(--gray-700);">' + escapeHtml(a.message) + '</div>';
          }
          return '<div style="display:flex;align-items:flex-start;gap:12px;padding:10px 14px;background:var(--gray-50);border-radius:8px;border-left:3px solid ' + color + ';">'
            + '<div style="min-width:60px;font-size:11px;color:var(--muted);white-space:nowrap;">' + escapeHtml(formatTs(a.ts)) + '</div>'
            + '<div style="flex:1;">'
            + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">'
            + '<span style="background:' + color + ';color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">' + escapeHtml(label) + '</span>'
            + statusPill
            + '<span style="font-size:12px;font-weight:600;">' + escapeHtml(a.tool_name) + '</span>'
            + '<span style="font-size:11px;color:var(--muted);">on ' + escapeHtml(a.server || '') + '</span>'
            + '</div>'
            + msgHtml
            + '</div>'
            + '<div style="font-size:11px;color:var(--muted);font-weight:600;">' + Math.round((a.confidence || 0) * 100) + '%</div>'
            + '</div>';
        }).join('');
        if (attackEmpty) attackEmpty.style.display = 'none';
      } else {
        if (attackTimeline) attackTimeline.innerHTML = '';
        if (attackEmpty) attackEmpty.style.display = '';
      }

      // Recent Decisions - combine audit + web sandbox verdicts
      // Filter: only show security-relevant events (deny/block/scan/council), not admin management events
      var SECURITY_EVENTS = ['source_sink_check', 'openai_proxy_block', 'council_decision', 'mcp_scan_run', 'causal_web_scan', 'semantic_scan', 'redteam_gemini'];
      var ADMIN_EVENTS = ['admin_session_issued', 'control_upstream_updated', 'upstream_test', 'token_issued', 'token_revoked', 'settings_updated'];
      var decisions = [];
      // From audit log - security events only
      if (auditRes && auditRes.ok && Array.isArray(auditRes.data)) {
        auditRes.data.filter(function(e) {
          var t = String(e.type || '');
          // Include: explicit security events, deny decisions, block events
          // Exclude: admin management events
          return ADMIN_EVENTS.indexOf(t) === -1;
        }).slice(0, 8).forEach(function(e) {
          var dec = 'allow';
          if (e.summary && (e.summary.indexOf('blocked') >= 0 || e.summary.indexOf('deny') >= 0)) dec = 'deny';
          else if (e.summary && e.summary.indexOf('quarantine') >= 0) dec = 'quarantine';
          else if (e.type && e.type.indexOf('block') >= 0) dec = 'deny';
          decisions.push({
            ts: e.ts,
            decision: dec,
            confidence: null,
            finding: e.summary || '-',
            evidence_id: e.evidence_id || '',
          });
        });
      }
      // From web sandbox verdicts (API + sessionStorage for cross-page freshness)
      var wv = (webVerdicts && webVerdicts.verdicts) || [];
      try {
        var ssVerdicts = JSON.parse(sessionStorage.getItem('mcp_latest_verdicts') || '[]');
        if (Array.isArray(ssVerdicts)) {
          var existingIds = wv.map(function(v) { return v.run_id; });
          ssVerdicts.forEach(function(sv) {
            if (sv.run_id && existingIds.indexOf(sv.run_id) === -1) wv.push(sv);
          });
        }
      } catch (_) { /* sessionStorage unavailable */ }
      wv.slice().reverse().slice(0, 5).forEach(function(v) {
        decisions.push({
          ts: v.timestamp,
          decision: v.recommended_action === 'block' ? 'deny' : v.recommended_action === 'warn' ? 'quarantine' : 'allow',
          confidence: v.confidence,
          finding: v.classification + (v.summary ? ': ' + v.summary.slice(0, 60) : ''),
          evidence_id: v.run_id || '',
        });
      });
      // Sort by timestamp desc
      decisions.sort(function(a, b) { return (b.ts || '') > (a.ts || '') ? 1 : -1; });
      decisions = decisions.slice(0, 10);

      var tbody = document.getElementById('decisionsBody');
      var emptyEl = document.getElementById('decisionsEmpty');
      var tableEl = document.getElementById('decisionsTable');
      if (decisions.length > 0) {
        tbody.innerHTML = decisions.map(function(dec) {
          var evidenceHtml = dec.evidence_id
            ? '<a class="evidence-link" href="audit_log.html?evidence_id=' + encodeURIComponent(dec.evidence_id) + '">' + escapeHtml(String(dec.evidence_id).slice(0, 12)) + '...</a>'
            : '-';
          var confHtml = dec.confidence != null ? confBar(dec.confidence) : '<span class="muted">-</span>';
          return '<tr><td style="white-space:nowrap;font-size:12px;">' + escapeHtml(formatTs(dec.ts)) + '</td><td>' + decisionPill(dec.decision) + '</td><td>' + confHtml + '</td><td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;">' + escapeHtml(dec.finding) + '</td><td>' + evidenceHtml + '</td></tr>';
        }).join('');
        tableEl.style.display = '';
        emptyEl.style.display = 'none';
      } else {
        tableEl.style.display = 'none';
        emptyEl.style.display = '';
      }
    }

    // Language toggle
    var langJa = document.getElementById('langJa');
    var langEn = document.getElementById('langEn');
    if (langJa) langJa.addEventListener('click', function() { setLang('ja'); applyI18n('ja'); init(); });
    if (langEn) langEn.addEventListener('click', function() { setLang('en'); applyI18n('en'); init(); });

    // Pipeline icons
    var STEP_ICONS = {
      shield: '\u{1F6E1}', alert: '\u26A0\uFE0F', pass: '\u2705', fail: '\u274C',
      allow: '\u2705', deny: '\u{1F6AB}', attack: '\u{1F525}', block: '\u{1F6AB}',
      warn: '\u26A0\uFE0F', scan: '\u{1F50D}', council: '\u{1F3DB}', web: '\u{1F310}'
    };
    // Flow diagram animation state
    var _flowAnimInterval = null;
    var _interceptStats = { blocked: 0, allowed: 0, dlp: 0 };
    function animateFlow(active) {
      var arrows = document.querySelectorAll('.flow-arrow');
      if (active) {
        _flowAnimInterval = setInterval(function() {
          arrows.forEach(function(a) { a.style.color = a.style.color === 'var(--primary)' ? '#8b5cf6' : 'var(--primary)'; });
        }, 600);
        document.querySelector('.flow-box.gateway').style.boxShadow = '0 0 20px rgba(0,102,255,0.3)';
      } else {
        if (_flowAnimInterval) { clearInterval(_flowAnimInterval); _flowAnimInterval = null; }
        arrows.forEach(function(a) { a.style.color = 'var(--primary)'; });
        document.querySelector('.flow-box.gateway').style.boxShadow = '';
      }
    }
    function updateFlowCounters() {
      var el = function(id) { return document.getElementById(id); };
      var d = I18N[getLang()] || I18N.en;
      el('flowAllowed').textContent = _interceptStats.allowed + ' ' + d.flowAllowed;
      el('flowBlocked').textContent = _interceptStats.blocked + ' ' + d.flowBlocked;
      // DLP counter in flow
      var dlpEl = el('flowDlp');
      if (dlpEl && _interceptStats.dlp > 0) {
        dlpEl.textContent = _interceptStats.dlp + ' DLP';
        dlpEl.style.display = '';
      }
    }

    // Connected Agents management
    var _connectedAgents = [];
    function addConnectedAgent(name, sessionId, model, color) {
      // Validate color (CSS injection defense: only hex colors allowed)
      var safeColor = /^#[0-9a-fA-F]{3,8}$/.test(color) ? color : '#6b7280';
      _connectedAgents.push({ name: name, sessionId: sessionId, model: model, color: safeColor });

      var grid = document.getElementById('agentsGrid');
      var empty = document.getElementById('agentsEmpty');
      var countEl = document.getElementById('agentsPanelCount');
      var hintEl = document.getElementById('agentsPanelHint');
      var dotsEl = document.getElementById('flowAgentDots');
      if (empty) empty.style.display = 'none';
      if (countEl) countEl.textContent = _connectedAgents.length;
      if (hintEl) hintEl.textContent = _connectedAgents.length + ' active sessions';

      // Truncate session ID for display (UX-002)
      var shortId = sessionId.length > 12 ? sessionId.slice(0, 12) + '\u2026' : sessionId;

      // Add agent card
      var card = document.createElement('div');
      card.className = 'agent-card active';
      card.style.animation = 'fadeSlideIn 0.3s ease-out';
      card.title = 'Session: ' + sessionId + '\nModel: ' + model;
      card.innerHTML = '<div class="agent-dot active" style="background:' + safeColor + '"></div>'
        + '<div class="agent-info">'
        + '<div class="agent-name">' + escapeHtml(name) + '</div>'
        + '<div class="agent-session">' + escapeHtml(shortId) + '</div>'
        + '<div class="agent-model">' + escapeHtml(model) + '</div>'
        + '</div>'
        + '<span class="agent-status connected">Active</span>';
      grid.appendChild(card);

      // Add colored dot to flow diagram left box
      if (dotsEl) {
        var dot = '<span style="display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;color:var(--muted)">'
          + '<span style="width:6px;height:6px;border-radius:50%;background:' + safeColor + ';display:inline-block"></span>'
          + escapeHtml(name.split(' ')[0])
          + '</span>';
        dotsEl.innerHTML += dot;
      }

      // Save to sessionStorage (TTL: cleared on session end)
      try {
        sessionStorage.setItem('mcp_connected_agents', JSON.stringify(_connectedAgents));
      } catch(_) {}
    }

    function clearConnectedAgents() {
      _connectedAgents = [];
      var grid = document.getElementById('agentsGrid');
      var empty = document.getElementById('agentsEmpty');
      var countEl = document.getElementById('agentsPanelCount');
      var hintEl = document.getElementById('agentsPanelHint');
      var dotsEl = document.getElementById('flowAgentDots');
      if (grid) grid.innerHTML = '';
      if (empty) { empty.style.display = ''; grid.appendChild(empty); }
      if (countEl) countEl.textContent = '0';
      if (hintEl) hintEl.textContent = 'Run pipeline to connect agents';
      if (dotsEl) dotsEl.innerHTML = '';
      try { sessionStorage.removeItem('mcp_connected_agents'); } catch(_) {}
    }

    // Restore connected agents from sessionStorage (with version check)
    (function() {
      try {
        var saved = sessionStorage.getItem('mcp_connected_agents');
        if (saved) {
          var agents = JSON.parse(saved);
          // Version check: reject stale data from old agent names
          var isStale = Array.isArray(agents) && agents.length > 0 && agents.some(function(a) {
            return a.name && (a.name.indexOf('Claude') >= 0 || a.name.indexOf('GPT') >= 0);
          });
          if (isStale) {
            sessionStorage.removeItem('mcp_connected_agents');
            // Also clear stale pipeline data that references old agent names
            localStorage.removeItem('mcp_pipeline_data');
          } else if (Array.isArray(agents) && agents.length > 0) {
            agents.forEach(function(a) {
              addConnectedAgent(a.name, a.sessionId, a.model, a.color);
            });
          }
        }
      } catch(_) {}
    })();

    // Latency badge helper
    function latencyBadge(ms) {
      if (!ms && ms !== 0) return '';
      var col = ms < 500 ? '#059669' : (ms < 2000 ? '#d97706' : '#dc2626');
      var bg = ms < 500 ? '#d1fae5' : (ms < 2000 ? '#fef3c7' : '#fee2e2');
      return ' <span style="background:' + bg + ';color:' + col + ';padding:1px 6px;border-radius:4px;font-size:10px;font-weight:700;font-family:monospace">\u26A1 ' + ms + 'ms</span>';
    }
    // Char-level diff for typosquatting
    function charDiff(actual, legit) {
      var result = { actual: '', legit: '' };
      var maxLen = Math.max(actual.length, legit.length);
      for (var i = 0; i < maxLen; i++) {
        var a = actual[i] || '', l = legit[i] || '';
        if (a !== l) {
          result.actual += '<span style="background:#ef4444;color:#fff;padding:0 2px;border-radius:2px;font-weight:800">' + escapeHtml(a) + '</span>';
          result.legit += '<span style="background:#10b981;color:#fff;padding:0 2px;border-radius:2px;font-weight:800">' + escapeHtml(l) + '</span>';
        } else {
          result.actual += escapeHtml(a);
          result.legit += escapeHtml(l);
        }
      }
      return result;
    }
    function pipelineStepHtml(d) {
      var ts = new Date().toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
      var icon = STEP_ICONS[d.icon] || '\u2022';
      var line = '';
      var detail = '';
      if (d.phase === 'register') {
        var trust = d.trust === 'trusted' ? '<span style="color:var(--success);font-weight:600">trusted</span>' : '<span style="color:var(--danger);font-weight:600">untrusted</span>';
        line = icon + ' LLM requests <b>' + escapeHtml(d.server) + '</b> (' + trust + ', ' + d.tools_count + ' tools) &rarr; Gateway intercepts';
      } else if (d.phase === 'scan') {
        var stcol = d.status === 'pass' ? 'var(--success)' : (d.status === 'warn' ? 'var(--warn)' : 'var(--danger)');
        line = icon + ' Scanned <b>' + escapeHtml(d.server) + '</b> &rarr; <span style="color:' + stcol + ';font-weight:700">' + escapeHtml(String(d.status).toUpperCase()) + '</span> (' + d.findings + ' findings)';
      } else if (d.phase === 'council') {
        var dcol = d.decision === 'allow' ? 'var(--success)' : (d.decision === 'quarantine' ? 'var(--warn)' : 'var(--danger)');
        var method = (d.eval_method === 'gemini3' || d.eval_method === 'gemini') ? ' <span style="background:#dbeafe;color:#1e40af;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600">Gemini 3</span>' : ' <span style="background:#f3f4f6;color:#6b7280;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600">Rule-based</span>';
        line = icon + ' Council: <b>' + escapeHtml(d.server) + '</b> &rarr; <span style="color:' + dcol + ';font-weight:700">' + escapeHtml(String(d.decision).toUpperCase()) + '</span>' + method + latencyBadge(d.latency_ms);
        // Expandable rationale
        if (d.rationale) {
          var scoresHtml = '';
          if (d.scores && typeof d.scores === 'object') {
            var keys = Object.keys(d.scores);
            if (keys.length > 0) {
              scoresHtml = '<div style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap">';
              keys.forEach(function(k) {
                var v = d.scores[k];
                var sc = v >= 0.7 ? '#059669' : (v >= 0.4 ? '#d97706' : '#dc2626');
                scoresHtml += '<span style="font-size:10px;color:' + sc + ';font-weight:600">' + escapeHtml(k) + ': ' + (v * 100).toFixed(0) + '%</span>';
              });
              scoresHtml += '</div>';
            }
          }
          var councilGf = '';
          if (d.gemini_features && d.gemini_features.length > 0) {
            councilGf = '<div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:3px">';
            d.gemini_features.forEach(function(f) {
              councilGf += '<span style="background:#ede9fe;color:#5b21b6;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600">' + escapeHtml(f.replace('_', ' ')) + '</span>';
            });
            councilGf += '</div>';
          }
          detail = '<div style="margin:4px 0 2px 24px;padding:6px 10px;background:#f8fafc;border-radius:6px;border-left:2px solid #dbeafe;font-size:11px;color:var(--gray-700)">'
            + '<span style="color:var(--muted);font-weight:600">Rationale:</span> ' + escapeHtml(d.rationale)
            + scoresHtml + councilGf + '</div>';
        }
      } else if (d.phase === 'attack') {
        // ── Enhanced Attack Visualization ──
        if (d.code === 'tool_shadowing' && d.actual_name && d.legitimate_name) {
          var diff = charDiff(d.actual_name, d.legitimate_name);
          line = icon + ' <span style="background:#dc2626;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">TOOL SHADOWING</span>'
            + ' <code style="background:#fee2e2;padding:3px 8px;border-radius:4px;font-family:\'SF Mono\',monospace;font-size:12px">' + diff.actual + '</code>'
            + ' <span style="color:var(--muted);margin:0 4px">mimics</span>'
            + ' <code style="background:#d1fae5;padding:3px 8px;border-radius:4px;font-family:\'SF Mono\',monospace;font-size:12px">' + diff.legit + '</code>'
            + ' <span style="font-size:11px;color:var(--muted)">(similarity: ' + Math.round((d.similarity || 0) * 100) + '%)</span>';
        } else if (d.code === 'signature_cloaking' && d.old_desc && d.new_desc) {
          line = icon + ' <span style="background:#dc2626;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">SIGNATURE CLOAKING</span>'
            + ' on <b>' + escapeHtml(d.tool) + '</b>';
          detail = '<div style="margin:4px 0 2px 24px;padding:8px 10px;background:#fef2f2;border-radius:6px;border-left:3px solid #dc2626;font-size:12px">'
            + '<div style="margin-bottom:4px"><span style="text-decoration:line-through;color:var(--muted)">"' + escapeHtml(d.old_desc) + '"</span></div>'
            + '<div><span style="color:#dc2626;font-weight:700">&darr; changed to</span></div>'
            + '<div style="margin-top:4px"><span style="color:#dc2626;font-weight:600">"' + escapeHtml(d.new_desc) + '"</span></div>'
            + '</div>';
        } else if (d.code === 'bait_and_switch') {
          var fields = (d.sensitive_fields || []).map(function(f) { return '<span style="background:#fee2e2;color:#991b1b;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600;font-family:monospace">' + escapeHtml(f) + '</span>'; }).join(' ');
          line = icon + ' <span style="background:#ea580c;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700">BAIT & SWITCH</span>'
            + ' <b>' + escapeHtml(d.tool) + '</b> claims benign but requests: ' + (fields || escapeHtml(d.message));
        } else {
          line = icon + ' <span style="color:var(--danger);font-weight:700">' + escapeHtml(d.code) + '</span> on <b>' + escapeHtml(d.tool) + '</b>: ' + escapeHtml(d.message);
        }
        if (d.confidence) {
          line += ' <span style="font-size:10px;color:var(--muted);font-weight:600">conf: ' + Math.round(d.confidence * 100) + '%</span>';
        }
      } else if (d.phase === 'web_sandbox') {
        var cls = d.classification;
        var ccol = cls === 'benign' ? 'var(--success)' : (cls === 'phishing' ? 'var(--danger)' : 'var(--warn)');
        var em = d.eval_method === 'gemini' ? ' <span style="background:#dbeafe;color:#1e40af;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600">Gemini 3</span>' : ' <span style="background:#f3f4f6;color:#6b7280;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600">Rule-based</span>';
        // Gemini 3 feature badges
        var gfBadges = '';
        if (d.gemini_features && d.gemini_features.length > 0) {
          gfBadges = '<div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:3px">';
          d.gemini_features.forEach(function(f) {
            var fLabel = f.replace('_', ' ');
            gfBadges += '<span style="background:#ede9fe;color:#5b21b6;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:600">' + escapeHtml(fLabel) + '</span>';
          });
          gfBadges += '</div>';
        }
        line = icon + ' <b>' + escapeHtml(d.label || d.url) + '</b> &rarr; <span style="color:' + ccol + ';font-weight:700">' + escapeHtml(String(cls).toUpperCase()) + '</span> (conf: ' + (d.confidence * 100).toFixed(0) + '%, ' + d.dom_threats + ' DOM threats, ' + (d.network_traces || 0) + ' network)' + em + latencyBadge(d.latency_ms);
        // Show risk indicators, summary, causal chain, attack narrative
        if (d.summary || (d.risk_indicators && d.risk_indicators.length > 0) || (d.causal_chain && d.causal_chain.length > 0)) {
          var riHtml = '';
          if (d.risk_indicators && d.risk_indicators.length > 0) {
            riHtml = '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px">';
            d.risk_indicators.forEach(function(ri) {
              riHtml += '<span style="background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600">' + escapeHtml(ri) + '</span>';
            });
            riHtml += '</div>';
          }
          // Causal chain (Gemini 3 unique)
          var chainHtml = '';
          if (d.causal_chain && d.causal_chain.length > 0) {
            chainHtml = '<div style="margin-top:6px;padding:4px 8px;background:#fef2f2;border-radius:4px;font-size:10px;color:#991b1b"><b>Causal Chain:</b>';
            d.causal_chain.forEach(function(step) {
              chainHtml += '<div style="margin:2px 0 0 8px">&rarr; <b>Step ' + step.step + ':</b> ' + escapeHtml(step.action) + ' &mdash; <i>' + escapeHtml(step.consequence) + '</i></div>';
            });
            chainHtml += '</div>';
          }
          // Attack narrative
          var narrHtml = '';
          if (d.attack_narrative) {
            narrHtml = '<div style="margin-top:4px;font-size:10px;color:#6b21a8;font-style:italic">' + escapeHtml(d.attack_narrative) + '</div>';
          }
          // MCP-specific threats
          var mcpHtml = '';
          if (d.mcp_threats && d.mcp_threats.length > 0) {
            mcpHtml = '<div style="margin-top:4px;display:flex;gap:3px;flex-wrap:wrap">';
            d.mcp_threats.forEach(function(t) {
              mcpHtml += '<span style="background:#fee2e2;color:#991b1b;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:600">MCP: ' + escapeHtml(t.substring(0, 80)) + '</span>';
            });
            mcpHtml += '</div>';
          }
          detail = '<div style="margin:4px 0 2px 24px;padding:6px 10px;background:#f8fafc;border-radius:6px;border-left:2px solid ' + ccol + ';font-size:11px;color:var(--gray-700)">'
            + (d.summary ? escapeHtml(d.summary) : '') + riHtml + gfBadges + chainHtml + narrHtml + mcpHtml + '</div>';
        }
      } else if (d.phase === 'intercept') {
        // ── Tool Call Interception Demo (Multi-Session) ──
        var sessColor = d.color || '#8b5cf6';
        var sessTag = d.agent ? '<span style="background:' + sessColor + ';color:#fff;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-right:4px">' + escapeHtml(d.agent) + '</span>' : '';
        if (d.action === 'session_start') {
          line = icon + ' <span style="background:' + sessColor + ';color:#fff;padding:2px 10px;border-radius:6px;font-size:11px;font-weight:700">SESSION</span> <b>' + escapeHtml(d.agent) + '</b> connected <span style="font-family:monospace;font-size:11px;color:var(--muted)">(' + escapeHtml(d.session_id) + ')</span> <span style="font-size:10px;color:var(--muted)">' + escapeHtml(d.model || '') + '</span>';
          // Update Connected Agents panel
          addConnectedAgent(d.agent, d.session_id, d.model || '', sessColor);
          // Update nav with multi-session indicator
          var navStatus = document.querySelector('.nav-status');
          if (navStatus) {
            var existing = navStatus.innerHTML;
            var badge = '<span style="display:inline-flex;align-items:center;gap:4px;margin-left:6px"><span style="width:8px;height:8px;border-radius:50%;background:' + sessColor + ';display:inline-block"></span><span style="font-size:11px;font-weight:600">' + escapeHtml(d.agent) + '</span></span>';
            navStatus.innerHTML = (existing.indexOf('inline-flex') >= 0 ? existing : '') + badge;
          }
        } else if (d.action === 'tool_call') {
          var rcol = d.result === 'BLOCKED' ? 'var(--danger)' : 'var(--success)';
          var rbg = d.result === 'BLOCKED' ? '#fee2e2' : '#d1fae5';
          var rtxt = d.result === 'BLOCKED' ? '#991b1b' : '#065f46';
          line = icon + ' ' + sessTag + '<b>' + escapeHtml(d.server) + '</b>.<b>' + escapeHtml(d.tool) + '</b>() &rarr; <span style="background:' + rbg + ';color:' + rtxt + ';padding:2px 10px;border-radius:6px;font-size:11px;font-weight:700">' + escapeHtml(d.result) + '</span> <span style="color:var(--muted);font-size:11px">' + escapeHtml(d.reason) + '</span>';
          if (d.result === 'BLOCKED') _interceptStats.blocked++;
          else _interceptStats.allowed++;
          updateFlowCounters();
        } else if (d.action === 'dlp_scan') {
          var findings = d.findings || [];
          line = icon + ' ' + sessTag + 'DLP scan on <b>' + escapeHtml(d.server) + '.' + escapeHtml(d.tool) + '</b> response &rarr; <span style="background:#fef3c7;color:#92400e;padding:2px 10px;border-radius:6px;font-size:11px;font-weight:700">SENSITIVE DATA</span> <span style="color:var(--warn);font-size:11px">[' + escapeHtml(findings.join(', ')) + ']</span>';
          _interceptStats.dlp++;
        } else if (d.action === 'session_summary') {
          line = icon + ' <span style="background:' + sessColor + ';color:#fff;padding:3px 12px;border-radius:6px;font-size:11px;font-weight:700">SUMMARY</span> ' + escapeHtml(d.message);
        }
      }
      // Use session color for border-left on intercept steps
      var borderColor = (d.phase === 'intercept' && d.color) ? d.color : 'transparent';
      var html = '<div style="padding: 3px 8px; animation: fadeSlideIn 0.3s ease-out; border-left: 3px solid ' + borderColor + ';" class="pipeline-step"><span style="color:var(--muted);margin-right:8px;">' + ts + '</span>' + line + '</div>';
      if (detail) html += detail;
      return html;
    }

    // Demo button handler — SSE live pipeline
    var demoBtn = document.getElementById('demoBtn');
    if (demoBtn) {
      demoBtn.addEventListener('click', function() {
        demoBtn.disabled = true;
        demoBtn.style.opacity = '0.6';
        demoBtn.querySelector('#demoBtnText').textContent = 'Scenario running...';

        var logPanel = document.getElementById('pipelineLog');
        var stepsEl = document.getElementById('pipelineSteps');
        var phaseEl = document.getElementById('pipelinePhase');
        var counterEl = document.getElementById('pipelineCounter');
        var iconEl = document.getElementById('pipelineIcon');
        logPanel.style.display = '';
        stepsEl.innerHTML = '';
        var stepCount = 0;

        _interceptStats = { blocked: 0, allowed: 0, dlp: 0 };
        clearConnectedAgents();
        animateFlow(true);

        var base = (window.apiClient && window.apiClient._base) || '';
        var sseUrl = base + '/api/demo/run-live';
        // SECURITY NOTE: EventSource API limitation — cannot set Authorization header.
        // Token is passed via query param. Mitigations: short-lived token, Referrer-Policy: no-referrer,
        // withCredentials for cookie-based auth fallback. Prefer cookie auth when available.
        var adminToken = (window.apiClient && window.apiClient.getAdminToken) ? window.apiClient.getAdminToken() : '';
        if (adminToken) sseUrl += '?token=' + encodeURIComponent(adminToken);
        var es = new EventSource(sseUrl, { withCredentials: true });

        es.addEventListener('phase', function(e) {
          var d = JSON.parse(e.data);
          phaseEl.textContent = d.label;
          var phaseIcons = {register: '\u{1F916}', scan: '\u{1F6E1}', council: '\u{2696}\uFE0F', attack: '\u{1F525}', web_sandbox: '\u{1F310}', intercept: '\u{1F6E1}\u{1F50D}'};
          iconEl.textContent = phaseIcons[d.name] || '\u2699\uFE0F';
          // Phase-specific flow highlight
          var gwBox = document.querySelector('.flow-box.gateway');
          if (d.name === 'intercept') {
            gwBox.style.borderColor = '#8b5cf6';
            gwBox.style.boxShadow = '0 0 24px rgba(139,92,246,0.4)';
          }
          // Add phase separator
          stepsEl.innerHTML += '<div style="padding: 6px 8px; color: #8b5cf6; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; border-bottom: 1px solid #ede9fe;">' + escapeHtml(d.label) + '</div>';
          stepsEl.scrollTop = stepsEl.scrollHeight;
        });

        es.addEventListener('step', function(e) {
          var d = JSON.parse(e.data);
          stepCount++;
          counterEl.textContent = stepCount + ' events';
          stepsEl.innerHTML += pipelineStepHtml(d);
          stepsEl.scrollTop = stepsEl.scrollHeight;
          // Refresh dashboard data periodically
          if (stepCount % 5 === 0) init();
        });

        es.addEventListener('complete', function(e) {
          es.close();
          animateFlow(false);
          var d = JSON.parse(e.data);
          counterEl.textContent = d.total_events + ' events — complete';
          phaseEl.textContent = 'Done';
          iconEl.textContent = '\u2705';
          // Show enforcement summary in pipeline log
          var summaryHtml = '<div style="padding: 10px 8px; background: linear-gradient(135deg,#f0fdf4,#ecfdf5); border-radius: 8px; margin-top: 8px; border: 1px solid #bbf7d0;">'
            + '<div style="font-weight:700;color:#166534;margin-bottom:4px;">\u2705 ' + escapeHtml(d.message) + '</div>'
            + '<div style="display:flex;gap:16px;font-size:12px;font-weight:600;">'
            + '<span style="color:var(--danger)">\u{1F6AB} ' + _interceptStats.blocked + ' Blocked</span>'
            + '<span style="color:var(--success)">\u2705 ' + _interceptStats.allowed + ' Allowed</span>'
            + '<span style="color:var(--warn)">\u26A0\uFE0F ' + _interceptStats.dlp + ' DLP</span>'
            + '</div></div>';
          stepsEl.innerHTML += summaryHtml;
          stepsEl.scrollTop = stepsEl.scrollHeight;
          // Restore gateway box style
          var gwBox = document.querySelector('.flow-box.gateway');
          gwBox.style.borderColor = 'var(--primary)';
          gwBox.style.boxShadow = '';
          demoBtn.disabled = false;
          demoBtn.style.opacity = '1';
          demoBtn.querySelector('#demoBtnText').textContent = I18N[getLang()].demoBtn;
          // Save pipeline results to localStorage for persistence across navigation (TTL: 30min)
          try {
            var pipelineData = {
              html: stepsEl.innerHTML,
              count: d.total_events + ' events \u2014 complete',
              stats: _interceptStats,
              ts: Date.now()
            };
            localStorage.setItem('mcp_pipeline_data', JSON.stringify(pipelineData));
          } catch(_) {}
          // Final dashboard refresh
          setTimeout(function() { init(); }, 500);
        });

        es.onerror = function() {
          es.close();
          animateFlow(false);
          counterEl.textContent = 'Connection lost';
          phaseEl.textContent = 'Error';
          iconEl.textContent = '\u274C';
          demoBtn.disabled = false;
          demoBtn.style.opacity = '1';
          demoBtn.querySelector('#demoBtnText').textContent = I18N[getLang()].demoBtn;
          // Try refreshing anyway
          init();
        };
      });
    }

    // Restore pipeline results from localStorage if available (TTL: 30min)
    (function() {
      try {
        var raw = localStorage.getItem('mcp_pipeline_data');
        if (raw) {
          var data = JSON.parse(raw);
          var TTL_MS = 30 * 60 * 1000; // 30 minutes
          if (data.ts && (Date.now() - data.ts) < TTL_MS && data.html) {
            var logPanel = document.getElementById('pipelineLog');
            var stepsEl = document.getElementById('pipelineSteps');
            var counterEl = document.getElementById('pipelineCounter');
            var phaseEl = document.getElementById('pipelinePhase');
            var iconEl = document.getElementById('pipelineIcon');
            logPanel.style.display = '';
            stepsEl.innerHTML = data.html;
            counterEl.textContent = data.count || '';
            phaseEl.textContent = 'Done';
            iconEl.textContent = '\u2705';
            if (data.stats) {
              _interceptStats = data.stats;
            }
          } else {
            // TTL expired, clean up
            localStorage.removeItem('mcp_pipeline_data');
          }
        }
        // Also clean up legacy keys
        localStorage.removeItem('mcp_pipeline_html');
        localStorage.removeItem('mcp_pipeline_count');
        localStorage.removeItem('mcp_pipeline_stats');
      } catch(_) {}
    })();

    applyI18n(getLang());
    // Threat Landscape count-up animation
    (function() {
      var stats = document.querySelectorAll('.threat-stat-value[data-target]');
      if (!stats.length) return;
      var animated = false;
      function animateCountUp() {
        if (animated) return;
        animated = true;
        stats.forEach(function(el) {
          var target = parseInt(el.getAttribute('data-target'), 10);
          var suffix = el.getAttribute('data-suffix') || '';
          var duration = 1800;
          var start = performance.now();
          function step(now) {
            var t = Math.min((now - start) / duration, 1);
            var ease = 1 - Math.pow(1 - t, 3);
            var current = Math.round(target * ease);
            if (target >= 1000) {
              el.textContent = current.toLocaleString() + '+';
            } else {
              el.textContent = current + suffix;
            }
            if (t < 1) requestAnimationFrame(step);
          }
          requestAnimationFrame(step);
        });
      }
      // Trigger on scroll into view or immediately if visible
      var panel = document.getElementById('threatLandscape');
      if (!panel) return;
      if (typeof IntersectionObserver !== 'undefined') {
        var obs = new IntersectionObserver(function(entries) {
          if (entries[0].isIntersecting) { animateCountUp(); obs.disconnect(); }
        }, { threshold: 0.3 });
        obs.observe(panel);
      } else {
        animateCountUp();
      }
    })();
    init();
  </script>
  <script>
    // --- Gemini API Key (shared across all features) ---
    (function() {
      var geminiForm = document.getElementById('dashGeminiForm');
      var geminiInput = document.getElementById('dashGeminiInput');
      var geminiBtn = document.getElementById('dashGeminiBtn');
      var geminiStatus = document.getElementById('dashGeminiStatus');
      var geminiError = document.getElementById('dashGeminiError');
      var geminiDesc = document.getElementById('dashGeminiDesc');
      if (!geminiForm) return;

      function getToken() {
        return (window.apiClient && window.apiClient.getAdminToken)
          ? window.apiClient.getAdminToken() : (window.SUITE_ADMIN_TOKEN || '');
      }

      function updateStatus(configured) {
        if (typeof configured !== 'undefined') updateStatus._configured = configured;
        var isConfigured = updateStatus._configured;
        var dl = I18N[getLang()] || I18N.en;
        if (isConfigured) {
          geminiStatus.textContent = dl.geminiConfigured || '\u2713 Configured';
          geminiStatus.style.background = 'var(--success)';
          geminiInput.placeholder = '\u2022\u2022\u2022\u2022 (configured)';
          geminiBtn.textContent = dl.geminiUpdateKey || 'Update Key';
          updateStatus._lastBtnLabel = dl.geminiUpdateKey || 'Update Key';
          geminiDesc.textContent = dl.geminiDescActive || 'Gemini API key is active. All AI-powered features are enabled.';
        } else {
          geminiStatus.textContent = dl.geminiNotConfigured || 'Not configured';
          geminiStatus.style.background = 'var(--danger)';
          geminiInput.placeholder = 'AIza...';
          geminiBtn.textContent = dl.geminiSetKey || 'Set Key';
          updateStatus._lastBtnLabel = dl.geminiSetKey || 'Set Key';
          geminiDesc.textContent = dl.geminiDesc || 'Enter your Google AI Studio API key to enable Gemini-powered analysis across all features (Council, Scanner, RedTeam, Web Sandbox).';
        }
      }
      window._geminiRefreshI18n = function() { updateStatus(); };

      async function checkStatus() {
        try {
          var token = getToken();
          var res = await fetch('/api/config/gemini-status', {
            headers: token ? { 'Authorization': 'Bearer ' + token } : {},
          });
          if (res.ok) {
            var data = await res.json();
            updateStatus(data.configured);
          }
        } catch (e) {
          updateStatus(false);
        }
      }

      geminiForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        geminiError.style.display = 'none';
        var key = geminiInput.value.trim();
        if (!key) {
          geminiError.textContent = 'Please enter a valid API key.';
          geminiError.style.display = '';
          return;
        }
        geminiBtn.disabled = true;
        geminiBtn.textContent = 'Setting...';
        try {
          var token = getToken();
          var hdrs = { 'Content-Type': 'application/json' };
          if (token) hdrs['Authorization'] = 'Bearer ' + token;
          var res = await fetch('/api/config/gemini-key', {
            method: 'POST',
            headers: hdrs,
            body: JSON.stringify({ api_key: key }),
          });
          if (res.ok) {
            geminiInput.value = '';
            await checkStatus();
          } else {
            var data = await res.json().catch(function() { return {}; });
            geminiError.textContent = data.detail || 'Failed to set key.';
            geminiError.style.display = '';
          }
        } catch (err) {
          geminiError.textContent = 'Network error: ' + err.message;
          geminiError.style.display = '';
        } finally {
          geminiBtn.disabled = false;
          geminiBtn.textContent = updateStatus._lastBtnLabel || 'Set Key';
        }
      });

      checkStatus();
    })();
  </script>
  <script>
    // --- Self-Tuning Card Logic ---
    (function () {
      var currentBars = document.getElementById('stCurrentBars');
      var proposedBars = document.getElementById('stProposedBars');
      var rationale = document.getElementById('stRationale');
      var impact = document.getElementById('stImpact');
      var applyBtn = document.getElementById('stApplyBtn');
      var refreshBtn = document.getElementById('stRefreshBtn');
      if (!currentBars) return;

      function renderBars(container, weights) {
        var colors = { security: '#ef4444', utility: '#3b82f6', cost: '#22c55e' };
        container.innerHTML = '';
        var safeKeys = ['security', 'utility', 'cost'];
        Object.keys(weights).forEach(function (k) {
          if (safeKeys.indexOf(k) === -1) return;
          var pct = Math.min(Math.max(parseFloat(weights[k]) || 0, 0), 1) * 100;
          var pctStr = pct.toFixed(1);
          var div = document.createElement('div');
          div.style.cssText = 'margin-bottom:6px;';
          var row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;';
          var label = document.createElement('span');
          label.style.textTransform = 'capitalize';
          label.textContent = k;
          var val = document.createElement('span');
          val.style.fontWeight = '600';
          val.textContent = pctStr + '%';
          row.appendChild(label); row.appendChild(val);
          var track = document.createElement('div');
          track.style.cssText = 'height:8px;background:var(--gray-100);border-radius:4px;overflow:hidden;';
          var bar = document.createElement('div');
          bar.style.cssText = 'height:100%;width:' + pctStr + '%;background:' + (colors[k] || '#6b7280') + ';border-radius:4px;transition:width 0.3s;';
          track.appendChild(bar);
          div.appendChild(row); div.appendChild(track);
          container.appendChild(div);
        });
      }

      async function loadSuggestion() {
        try {
          var res = window.apiClient && await window.apiClient.fetchSelfTuningSuggestion();
          if (res && res.ok && res.data) {
            renderBars(currentBars, res.data.current_weights || {});
            renderBars(proposedBars, res.data.proposed_weights || {});
            if (rationale) rationale.textContent = res.data.rationale || '';
            if (impact) impact.textContent = res.data.impact_estimate || '';
          }
        } catch (e) {
          if (rationale) rationale.textContent = 'Failed to load: ' + e.message;
        }
      }

      if (applyBtn) applyBtn.addEventListener('click', async function () {
        applyBtn.disabled = true;
        try {
          var res = window.apiClient && await window.apiClient.applySelfTuning();
          if (res && res.ok) {
            if (rationale) rationale.textContent = 'Weights applied successfully.';
            await loadSuggestion();
          } else {
            if (rationale) rationale.textContent = 'Apply failed. Try again.';
          }
        } catch (e) {
          if (rationale) rationale.textContent = 'Error: ' + e.message;
        } finally {
          applyBtn.disabled = false;
        }
      });
      if (refreshBtn) refreshBtn.addEventListener('click', loadSuggestion);
      loadSuggestion();
    })();
  </script>
  <script>
    document.querySelectorAll('.nav-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        var href = this.getAttribute('href');
        if (href && !href.startsWith('#') && !href.startsWith('javascript')) {
          e.preventDefault();
          document.body.style.opacity = '0';
          setTimeout(function() { window.location.href = href; }, 80);
        }
      });
    });
  </script>
</body>

</html>
